/*! third party licenses: dist/vendor.LICENSE.txt */
import{bH as b,aH as h,V as I,F as S,bE as p,bP as x}from"./core-common.mjs";import"./chunks/index-Ca0QcE7e.mjs";import{v as A}from"./chunks/toast-7xJhDYMn-BrG8uCqw.mjs";import{p as R}from"./chunks/v-tooltip.esm-CZvp28yr.mjs";import{n as T,R as D,p as N,q as V}from"./chunks/icons-BxSPavMS.mjs";import{C as y,a as j}from"./chunks/CommentView-iRU-VSYw.mjs";import{c as P,g as E,D as v}from"./chunks/GetComments-CkCWKSs2.mjs";import{l as q}from"./chunks/logger-qoNNX8HU.mjs";import"./chunks/_setToString-D2g9rVjk.mjs";import"./chunks/_Set-Cq4kerQ7.mjs";import"./chunks/_isIterateeCall-cIIcpi4J.mjs";import"./chunks/isPlainObject-wZJk5EJL.mjs";import"./chunks/preload-helper-3Yr03P9X.mjs";import"./chunks/index-Biv1VH4I.mjs";import"./chunks/headers-Irz06Lip.mjs";import"./chunks/util-Bowr8LpN.mjs";import"./chunks/json2xml-BRHZ5XL4.mjs";function f(e){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?f=function(t){return typeof t}:f=function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},f(e)}function F(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function g(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function M(e,t,n){return t&&g(e.prototype,t),n&&g(e,n),e}function C(e){return z(e)||L(e)||B()}function z(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}function L(e){if(Symbol.iterator in Object(e)||Object.prototype.toString.call(e)==="[object Arguments]")return Array.from(e)}function B(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function H(e){var t;return typeof e=="function"?t={callback:e}:t=e,t}function $(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},o,s,a,i=function(r){for(var c=arguments.length,l=new Array(c>1?c-1:0),u=1;u<c;u++)l[u-1]=arguments[u];if(a=l,!(o&&r===s)){var m=n.leading;typeof m=="function"&&(m=m(r,s)),(!o||r!==s)&&m&&e.apply(void 0,[r].concat(C(a))),s=r,clearTimeout(o),o=setTimeout(function(){e.apply(void 0,[r].concat(C(a))),o=0},t)}};return i._clear=function(){clearTimeout(o),o=null},i}function _(e,t){if(e===t)return!0;if(f(e)==="object"){for(var n in e)if(!_(e[n],t[n]))return!1;return!0}return!1}var U=function(){function e(t,n,o){F(this,e),this.el=t,this.observer=null,this.frozen=!1,this.createObserver(n,o)}return M(e,[{key:"createObserver",value:function(t,n){var o=this;if(this.observer&&this.destroyObserver(),!this.frozen){if(this.options=H(t),this.callback=function(i,r){o.options.callback(i,r),i&&o.options.once&&(o.frozen=!0,o.destroyObserver())},this.callback&&this.options.throttle){var s=this.options.throttleOptions||{},a=s.leading;this.callback=$(this.callback,this.options.throttle,{leading:function(i){return a==="both"||a==="visible"&&i||a==="hidden"&&!i}})}this.oldResult=void 0,this.observer=new IntersectionObserver(function(i){var r=i[0];if(i.length>1){var c=i.find(function(u){return u.isIntersecting});c&&(r=c)}if(o.callback){var l=r.isIntersecting&&r.intersectionRatio>=o.threshold;if(l===o.oldResult)return;o.oldResult=l,o.callback(l,r)}},this.options.intersection),n.context.$nextTick(function(){o.observer&&o.observer.observe(o.el)})}}},{key:"destroyObserver",value:function(){this.observer&&(this.observer.disconnect(),this.observer=null),this.callback&&this.callback._clear&&(this.callback._clear(),this.callback=null)}},{key:"threshold",get:function(){return this.options.intersection&&typeof this.options.intersection.threshold=="number"?this.options.intersection.threshold:0}}]),e}();function w(e,t,n){var o=t.value;if(o)if(typeof IntersectionObserver>"u")console.warn("[vue-observe-visibility] IntersectionObserver API is not available in your browser. Please install this polyfill: https://github.com/w3c/IntersectionObserver/tree/master/polyfill");else{var s=new U(e,o,n);e._vue_visibilityState=s}}function G(e,t,n){var o=t.value,s=t.oldValue;if(!_(o,s)){var a=e._vue_visibilityState;if(!o){O(e);return}a?a.createObserver(o,n):w(e,{value:o},n)}}function O(e){var t=e._vue_visibilityState;t&&(t.destroyObserver(),delete e._vue_visibilityState)}var J={bind:w,update:G,unbind:O};function K(e){e.directive("observe-visibility",J)}var k={version:"1.0.0",install:K},d=null;typeof window<"u"?d=window.Vue:typeof b<"u"&&(d=b.Vue),d&&d.use(k);const Q=function(e){const t=new AbortController,n=t.signal;return{request:async function(o,s){return await e(o,Object.assign({signal:n},s))},abort:()=>t.abort()}},W=(e,t,n)=>{const o=["",e,t].join("/"),s=n.toUTCString();return P.customRequest(o,{method:"PROPPATCH",data:'<?xml version="1.0"?>\n			<d:propertyupdate\n				xmlns:d="DAV:"\n				xmlns:oc="http://owncloud.org/ns">\n			<d:set>\n				<d:prop>\n					<oc:readMarker>'.concat(s,"</oc:readMarker>\n				</d:prop>\n			</d:set>\n			</d:propertyupdate>")})};h.use(R),h.use(k);const X={name:"Comments",components:{Comment:y,NcEmptyContent:I,NcButton:S,RefreshIcon:D,MessageReplyTextIcon:N,AlertCircleOutlineIcon:V},mixins:[j],data(){return{error:"",loading:!1,done:!1,resourceId:null,offset:0,comments:[],cancelRequest:()=>{},Comment:y,userData:{}}},computed:{hasComments(){return this.comments.length>0},isFirstLoading(){return this.loading&&this.offset===0}},methods:{t:p,async onVisibilityChange(e){if(e)try{await W(this.resourceType,this.resourceId,new Date)}catch(t){A(t.message||p("comments","Failed to mark comments as read"))}},async update(e){this.resourceId=e,this.resetState(),this.getComments()},onScrollBottomReached(){this.error||this.done||this.loading||this.getComments()},async getComments(){this.cancelRequest("cancel");try{this.loading=!0,this.error="";const{request:e,abort:t}=Q(E);this.cancelRequest=t;const{data:n}=await e({resourceType:this.resourceType,resourceId:this.resourceId},{offset:this.offset})||{data:[]};this.logger.debug("Processed ".concat(n.length," comments"),{comments:n}),n.length<v&&(this.done=!0),this.comments.push(...n),this.offset+=v}catch(e){if(e.message==="cancel")return;this.error=p("comments","Unable to load the comments list"),console.error("Error loading the comments list",e)}finally{this.loading=!1}},onNewComment(e){this.comments.unshift(e)},onDelete(e){const t=this.comments.findIndex(n=>n.props.id===e);t>-1?this.comments.splice(t,1):console.error("Could not find the deleted comment in the list",e)},resetState(){this.error="",this.loading=!1,this.done=!1,this.offset=0,this.comments=[]}}};var Y=function(){var e=this,t=e._self._c;return t("div",{directives:[{name:"observe-visibility",rawName:"v-observe-visibility",value:e.onVisibilityChange,expression:"onVisibilityChange"}],staticClass:"comments",class:{"icon-loading":e.isFirstLoading}},[t("Comment",e._b({staticClass:"comments__writer",attrs:{"auto-complete":e.autoComplete,"resource-type":e.resourceType,editor:!0,"user-data":e.userData,"resource-id":e.resourceId},on:{new:e.onNewComment}},"Comment",e.editorData,!1)),e.isFirstLoading?e._e():[!e.hasComments&&e.done?t("NcEmptyContent",{staticClass:"comments__empty",attrs:{name:e.t("comments","No comments yet, start the conversation!")},scopedSlots:e._u([{key:"icon",fn:function(){return[t("MessageReplyTextIcon")]},proxy:!0}],null,!1,1033639148)}):t("ul",e._l(e.comments,function(n){return t("Comment",e._b({key:n.props.id,staticClass:"comments__list",attrs:{tag:"li","auto-complete":e.autoComplete,"resource-type":e.resourceType,message:n.props.message,"resource-id":e.resourceId,"user-data":e.genMentionsData(n.props.mentions)},on:{"update:message":function(o){return e.$set(n.props,"message",o)},delete:e.onDelete}},"Comment",n.props,!1))}),1),e.loading&&!e.isFirstLoading?t("div",{staticClass:"comments__info icon-loading"}):e.hasComments&&e.done?t("div",{staticClass:"comments__info"},[e._v(" "+e._s(e.t("comments","No more messages"))+" ")]):e.error?[t("NcEmptyContent",{staticClass:"comments__error",attrs:{name:e.error},scopedSlots:e._u([{key:"icon",fn:function(){return[t("AlertCircleOutlineIcon")]},proxy:!0}],null,!1,66050004)}),t("NcButton",{staticClass:"comments__retry",on:{click:e.getComments},scopedSlots:e._u([{key:"icon",fn:function(){return[t("RefreshIcon")]},proxy:!0}],null,!1,3924573781)},[e._v(" "+e._s(e.t("comments","Retry"))+" ")])]:e._e()]],2)},Z=[],ee=T(X,Y,Z,!1,null,"78933782",null,null);const te=ee.exports;h.mixin({data(){return{logger:q}},methods:{t:p,n:x}});class oe{constructor(t="files",n={}){var s;n={...n,propsData:{...(s=n.propsData)!=null?s:{},resourceType:t}};const o=h.extend(te);return new o(n)}}window.OCA&&!window.OCA.Comments&&Object.assign(window.OCA,{Comments:{}}),Object.assign(window.OCA.Comments,{View:oe}),console.debug("OCA.Comments.View initialized");
