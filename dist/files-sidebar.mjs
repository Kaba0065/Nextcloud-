/*! third party licenses: dist/vendor.LICENSE.txt */
var x=Object.defineProperty;var L=(e,i,s)=>i in e?x(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s;var r=(e,i,s)=>(L(e,typeof i!="symbol"?i+"":i,s),s);import{bD as I,B as $,V as A,aH as p,a2 as D,ae as N,bE as d,b as M,A as R,b$ as P,bC as c,bJ as k,bG as z,cL as B}from"./core-common.mjs";import{e as U}from"./chunks/index-DgCiVkaQ.mjs";import{s as q,_ as j,y as H}from"./chunks/index-BLIV22dB.mjs";import{T}from"./chunks/index-YIotKjSS.mjs";import{$ as V}from"./chunks/jquery-CAX9BRLJ.mjs";import{m as X}from"./chunks/index-j_UZebeA.mjs";import{n as g,j as W,k as Y}from"./chunks/icons-BxSPavMS.mjs";import"./chunks/index-Ca0QcE7e.mjs";import{v as h}from"./chunks/toast-7xJhDYMn-BrG8uCqw.mjs";import{b as y,e as G,p as J,l as w,g as F,c as K,f as Q,h as Z,d as S}from"./chunks/api-WoSfe-uM.mjs";import{O as ee,a as te,n as ie,v as O,j as se}from"./chunks/json2xml-BRHZ5XL4.mjs";import"./chunks/index-Biv1VH4I.mjs";import"./chunks/moment-B-oAqI-A.mjs";import"./chunks/moment-B1DRcIE-.mjs";const{buildOptions:ne}=ee,oe=te,{prettify:ae}=ie,re=O;let le=class{constructor(e){this.externalEntities={},this.options=ne(e)}parse(e,i){if(typeof e!="string")if(e.toString)e=e.toString();else throw new Error("XML data is accepted in String or Bytes[] form.");if(i){i===!0&&(i={});const o=re.validate(e,i);if(o!==!0)throw Error("".concat(o.err.msg,":").concat(o.err.line,":").concat(o.err.col))}const s=new oe(this.options);s.addExternalEntities(this.externalEntities);const n=s.parseXml(e);return this.options.preserveOrder||n===void 0?n:ae(n,this.options)}addEntity(e,i){if(i.indexOf("&")!==-1)throw new Error("Entity value can't have '&'");if(e.indexOf("&")!==-1||e.indexOf(";")!==-1)throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if(i==="&")throw new Error("An entity with value '&' is not permitted");this.externalEntities[e]=i}};var de=le;const ce=O,he=de,fe=se;var ue={XMLParser:he,XMLValidator:ce,XMLBuilder:fe};async function ge(e){const i=await I({method:"PROPFIND",url:e,data:q()}),s=OC.Files.getClient()._client.parseMultiStatus(i.data),n=OC.Files.getClient()._parseFileInfo(s[0]);return n.get=o=>n[o],n.isDirectory=()=>n.mimetype==="httpd/unix-directory",n}const pe={name:"LegacyView",props:{component:{type:Object,required:!0},fileInfo:{type:Object,default:()=>{},required:!0}},watch:{fileInfo(e){this.setFileInfo(e)}},mounted(){this.component.$el.replaceAll(this.$el),this.setFileInfo(this.fileInfo)},methods:{setFileInfo(e){this.component.setFileInfo(new OCA.Files.FileInfoModel(e))}}};var me=function(){var e=this,i=e._self._c;return i("div")},ye=[],we=g(pe,me,ye,!1,null,null,null,null);const be=we.exports,ve={name:"SidebarTab",components:{NcAppSidebarTab:$,NcEmptyContent:A},props:{fileInfo:{type:Object,default:()=>{},required:!0},id:{type:String,required:!0},name:{type:String,required:!0},icon:{type:String,required:!1},onMount:{type:Function,required:!0},onUpdate:{type:Function,required:!0},onDestroy:{type:Function,required:!0},onScrollBottomReached:{type:Function,default:()=>{}}},data(){return{loading:!0}},computed:{activeTab(){return this.$parent.activeTab}},watch:{async fileInfo(e,i){e.id!==i.id&&(this.loading=!0,await this.onUpdate(this.fileInfo),this.loading=!1)}},async mounted(){this.loading=!0,await this.onMount(this.$refs.mount,this.fileInfo,this.$refs.tab),this.loading=!1},async beforeDestroy(){await this.onDestroy()}};var Te=function(){var e=this,i=e._self._c;return i("NcAppSidebarTab",{ref:"tab",attrs:{id:e.id,name:e.name,icon:e.icon},on:{bottomReached:e.onScrollBottomReached},scopedSlots:e._u([{key:"icon",fn:function(){return[e._t("icon")]},proxy:!0}],null,!0)},[e.loading?i("NcEmptyContent",{attrs:{icon:"icon-loading"}}):e._e(),i("div",{ref:"mount"})],1)},Se=[],_e=g(ve,Te,Se,!1,null,null,null,null);const Ie=_e.exports,Ae=async e=>{const i="/systemtags-relations/files/"+e;try{const{data:s}=await y.getDirectoryContents(i,{data:G,details:!0,glob:"/systemtags-relations/files/*/*"});return J(s)}catch(s){throw w.error(t("systemtags","Failed to load tags for file"),{error:s}),new Error(t("systemtags","Failed to load tags for file"))}},Fe=async(e,i)=>{const s=F(e),n=await K(s),o={...s,id:n};return await C(o,i),o.id},C=async(e,i)=>{const s="/systemtags-relations/files/"+i+"/"+e.id,n=F(e);try{await y.customRequest(s,{method:"PUT",data:n})}catch(o){throw w.error(t("systemtags","Failed to set tag for file"),{error:o}),new Error(t("systemtags","Failed to set tag for file"))}},Oe=async(e,i)=>{const s="/systemtags-relations/files/"+i+"/"+e.id;try{await y.deleteFile(s)}catch(n){throw w.error(t("systemtags","Failed to delete tag for file"),{error:n}),new Error(t("systemtags","Failed to delete tag for file"))}},Ce=p.extend({name:"SystemTags",components:{NcLoadingIcon:D,NcSelectTags:N},props:{fileId:{type:Number,required:!0}},data(){return{sortedTags:[],selectedTags:[],loadingTags:!1,loading:!1}},async created(){try{const e=await Q(),i=await Z(),s=[],n=[];for(const a of e){if(i.includes(a.id)){s.push(a);continue}n.push(a)}const o=(a,l)=>i.indexOf(a.id)-i.indexOf(l.id);s.sort(o),this.sortedTags=[...s,...n]}catch{h(d("systemtags","Failed to load tags"))}},watch:{fileId:{immediate:!0,async handler(){this.loadingTags=!0;try{this.selectedTags=await Ae(this.fileId),this.$emit("has-tags",this.selectedTags.length>0)}catch{h(d("systemtags","Failed to load selected tags"))}this.loadingTags=!1}}},methods:{t:d,createOption(e){for(const i of this.sortedTags){const{id:s,displayName:n,...o}=i;if(n===e&&Object.entries(o).every(([a,l])=>S[a]===l))return i}return{...S,displayName:e}},handleInput(e){this.selectedTags=e.filter(i=>!!i.id)},async handleSelect(e){const i=e[e.length-1];if(!i.id)return;const s=i;this.loading=!0;try{await C(s,this.fileId);const n=(o,a)=>o.id===s.id?-1:a.id===s.id?1:0;this.sortedTags.sort(n)}catch{h(d("systemtags","Failed to select tag"))}this.loading=!1},async handleCreate(e){this.loading=!0;try{const i=await Fe(e,this.fileId),s={...e,id:i};this.sortedTags.unshift(s),this.selectedTags.push(s)}catch{h(d("systemtags","Failed to create tag"))}this.loading=!1},async handleDeselect(e){this.loading=!0;try{await Oe(e,this.fileId)}catch{h(d("systemtags","Failed to delete tag"))}this.loading=!1}}});var Ee=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("div",{staticClass:"system-tags"},[e.loadingTags?i("NcLoadingIcon",{attrs:{name:e.t("systemtags","Loading collaborative tags …"),size:32}}):[i("label",{attrs:{for:"system-tags-input"}},[e._v(e._s(e.t("systemtags","Search or create collaborative tags")))]),i("NcSelectTags",{staticClass:"system-tags__select",attrs:{"input-id":"system-tags-input",placeholder:e.t("systemtags","Collaborative tags …"),options:e.sortedTags,value:e.selectedTags,"create-option":e.createOption,taggable:!0,passthru:!0,"fetch-tags":!1,loading:e.loading},on:{input:e.handleInput,"option:selected":e.handleSelect,"option:created":e.handleCreate,"option:deselected":e.handleDeselect},scopedSlots:e._u([{key:"no-options",fn:function(){return[e._v(" "+e._s(e.t("systemtags","No tags to select, type to create a new tag"))+" ")]},proxy:!0}])})]],2)},xe=[],Le=g(Ce,Ee,xe,!1,null,"a624b5f7",null,null);const $e=Le.exports,De={name:"Sidebar",components:{LegacyView:be,NcActionButton:M,NcAppSidebar:R,NcEmptyContent:A,SidebarTab:Ie,SystemTags:$e,Star:W,StarOutline:Y},data(){return{Sidebar:OCA.Files.Sidebar.state,showTags:!1,showTagsDefault:!0,error:null,loading:!0,fileInfo:null,starLoading:!1,isFullScreen:!1,hasLowHeight:!1}},computed:{file(){return this.Sidebar.file},tabs(){return this.Sidebar.tabs},views(){return this.Sidebar.views},davPath(){const e=OC.getCurrentUser().uid;return OC.linkToRemote("dav/files/".concat(e).concat(U(this.file)))},activeTab(){return this.Sidebar.activeTab},subtitle(){return"".concat(this.fileInfo.isFavourited?"★ ":""," ").concat(this.size,", ").concat(this.time)},time(){return OC.Util.relativeModifiedDate(this.fileInfo.mtime)},fullTime(){return X(this.fileInfo.mtime).format("LLL")},size(){return OC.Util.humanFileSize(this.fileInfo.size)},background(){return this.getPreviewIfAny(this.fileInfo)},appSidebar(){return this.fileInfo?{"data-mimetype":this.fileInfo.mimetype,"star-loading":this.starLoading,active:this.activeTab,background:this.background,class:{"app-sidebar--has-preview":this.fileInfo.hasPreview&&!this.isFullScreen,"app-sidebar--full":this.isFullScreen},compact:this.hasLowHeight||!this.fileInfo.hasPreview||this.isFullScreen,loading:this.loading,subname:this.subtitle,subtitle:this.fullTime,name:this.fileInfo.name,title:this.fileInfo.name}:this.error?{key:"error",subname:"",name:"",class:{"app-sidebar--full":this.isFullScreen}}:{loading:this.loading,subname:"",name:"",class:{"app-sidebar--full":this.isFullScreen}}},defaultAction(){return this.fileInfo&&OCA.Files&&OCA.Files.App&&OCA.Files.App.fileList&&OCA.Files.App.fileList.fileActions&&OCA.Files.App.fileList.fileActions.getDefaultFileAction&&OCA.Files.App.fileList.fileActions.getDefaultFileAction(this.fileInfo.mimetype,this.fileInfo.type,OC.PERMISSION_READ)},defaultActionListener(){return this.defaultAction?"figure-click":null},isSystemTagsEnabled(){var e,i;return((i=(e=P())==null?void 0:e.systemtags)==null?void 0:i.enabled)===!0}},created(){window.addEventListener("resize",this.handleWindowResize),this.handleWindowResize()},beforeDestroy(){window.removeEventListener("resize",this.handleWindowResize)},methods:{canDisplay(e){return e.enabled(this.fileInfo)},resetData(){this.error=null,this.fileInfo=null,this.$nextTick(()=>{this.$refs.tabs&&this.$refs.tabs.updateTabs()})},getPreviewIfAny(e){return e.hasPreview&&!this.isFullScreen?OC.generateUrl("/core/preview?fileId=".concat(e.id,"&x=").concat(screen.width,"&y=").concat(screen.height,"&a=true")):this.getIconUrl(e)},getIconUrl(e){const i=e.mimetype||"application/octet-stream";return i==="httpd/unix-directory"?e.mountType==="shared"||e.mountType==="shared-root"?OC.MimeType.getIconUrl("dir-shared"):e.mountType==="external-root"?OC.MimeType.getIconUrl("dir-external"):e.mountType!==void 0&&e.mountType!==""?OC.MimeType.getIconUrl("dir-"+e.mountType):e.shareTypes&&(e.shareTypes.indexOf(T.SHARE_TYPE_LINK)>-1||e.shareTypes.indexOf(T.SHARE_TYPE_EMAIL)>-1)?OC.MimeType.getIconUrl("dir-public"):e.shareTypes&&e.shareTypes.length>0?OC.MimeType.getIconUrl("dir-shared"):OC.MimeType.getIconUrl("dir"):OC.MimeType.getIconUrl(i)},setActiveTab(e){OCA.Files.Sidebar.setActiveTab(e),this.tabs.forEach(i=>{try{i.setIsActive(e===i.id)}catch(s){logger.error("Error while setting tab active state",{error:s,id:i.id,tab:i})}})},async toggleStarred(e){try{this.starLoading=!0,await I({method:"PROPPATCH",url:this.davPath,data:'<?xml version="1.0"?>\n						<d:propertyupdate xmlns:d="DAV:" xmlns:oc="http://owncloud.org/ns">\n						'.concat(e?"<d:set>":"<d:remove>","\n							<d:prop>\n								<oc:favorite>1</oc:favorite>\n							</d:prop>\n						").concat(e?"</d:set>":"</d:remove>","\n						</d:propertyupdate>")});const i=this.fileInfo.type==="dir",s=i?j:H;c(e?"files:favorites:added":"files:favorites:removed",new s({fileid:this.fileInfo.id,source:this.davPath,root:"/files/".concat(k().uid),mime:i?void 0:this.fileInfo.mimetype}))}catch(i){OC.Notification.showTemporary(t("files","Unable to change the favourite state of the file")),console.error("Unable to change favourite state",i)}this.starLoading=!1},onDefaultAction(){this.defaultAction&&this.defaultAction.action(this.fileInfo.name,{fileInfo:this.fileInfo,dir:this.fileInfo.dir,fileList:OCA.Files.App.fileList,$file:V("body")})},toggleTags(){this.showTagsDefault=this.showTags=!this.showTags},async open(e){if(!e||e.trim()==="")throw new Error("Invalid path '".concat(e,"'"));const i=!!this.Sidebar.file;this.Sidebar.file=e,this.error=null,this.loading=!0;try{this.fileInfo=await ge(this.davPath),this.fileInfo.dir=this.file.split("/").slice(0,-1).join("/"),this.views.forEach(s=>{s.setFileInfo(this.fileInfo)}),await this.$nextTick(),this.setActiveTab(this.Sidebar.activeTab||this.tabs[0].id),this.loading=!1,await this.$nextTick(),i&&this.$refs.sidebar.focusActiveTabContent()}catch(s){throw this.loading=!1,this.error=t("files","Error while loading the file data"),console.error("Error while loading the file data",s),new Error(s)}},close(){this.Sidebar.file="",this.showTags=!1,this.resetData()},setFullScreenMode(e){var i,s,n,o;this.isFullScreen=e,e?(i=document.querySelector("#content"))!=null&&i.classList.add("with-sidebar--full")||((s=document.querySelector("#content-vue"))==null||s.classList.add("with-sidebar--full")):(n=document.querySelector("#content"))!=null&&n.classList.remove("with-sidebar--full")||((o=document.querySelector("#content-vue"))==null||o.classList.remove("with-sidebar--full"))},setShowTagsDefault(e){this.showTagsDefault=e},handleOpening(){c("files:sidebar:opening")},handleOpened(){c("files:sidebar:opened")},handleClosing(){c("files:sidebar:closing")},handleClosed(){c("files:sidebar:closed")},handleWindowResize(){this.hasLowHeight=document.documentElement.clientHeight<1024}}};var Ne=function(){var e=this,i=e._self._c;return e.file?i("NcAppSidebar",e._b({ref:"sidebar",attrs:{"force-menu":!0},on:e._d({close:e.close,"update:active":e.setActiveTab,opening:e.handleOpening,opened:e.handleOpened,closing:e.handleClosing,closed:e.handleClosed},[e.defaultActionListener,function(s){return s.stopPropagation(),s.preventDefault(),e.onDefaultAction.apply(null,arguments)}]),scopedSlots:e._u([e.fileInfo?{key:"description",fn:function(){return[i("div",{staticClass:"sidebar__description"},[e.isSystemTagsEnabled&&e.showTagsDefault?i("SystemTags",{directives:[{name:"show",rawName:"v-show",value:e.showTags,expression:"showTags"}],attrs:{"file-id":e.fileInfo.id},on:{"has-tags":s=>e.showTags=s}}):e._e(),e._l(e.views,function(s){return i("LegacyView",{key:s.cid,attrs:{component:s,"file-info":e.fileInfo}})})],2)]},proxy:!0}:null,e.fileInfo?{key:"secondary-actions",fn:function(){return[i("NcActionButton",{attrs:{"close-after-click":!0},on:{click:function(s){return e.toggleStarred(!e.fileInfo.isFavourited)}},scopedSlots:e._u([e.fileInfo.isFavourited?{key:"icon",fn:function(){return[i("StarOutline",{attrs:{size:20}})]},proxy:!0}:{key:"icon",fn:function(){return[i("Star",{attrs:{size:20}})]},proxy:!0}],null,!0)},[e._v(" "+e._s(e.fileInfo.isFavourited?e.t("files","Remove from favorites"):e.t("files","Add to favorites"))+" ")]),e.isSystemTagsEnabled?i("NcActionButton",{attrs:{"close-after-click":!0,icon:"icon-tag"},on:{click:e.toggleTags}},[e._v(" "+e._s(e.t("files","Tags"))+" ")]):e._e()]},proxy:!0}:null],null,!0)},"NcAppSidebar",e.appSidebar,!1),[e.error?i("NcEmptyContent",{attrs:{icon:"icon-error"}},[e._v(" "+e._s(e.error)+" ")]):e.fileInfo?e._l(e.tabs,function(s){return[s.enabled(e.fileInfo)?i("SidebarTab",{directives:[{name:"show",rawName:"v-show",value:!e.loading,expression:"!loading"}],key:s.id,attrs:{id:s.id,name:s.name,icon:s.icon,"on-mount":s.mount,"on-update":s.update,"on-destroy":s.destroy,"on-scroll-bottom-reached":s.scrollBottomReached,"file-info":e.fileInfo},scopedSlots:e._u([s.iconSvg!==void 0?{key:"icon",fn:function(){return[i("span",{staticClass:"svg-icon",domProps:{innerHTML:e._s(s.iconSvg)}})]},proxy:!0}:null],null,!0)}):e._e()]}):e._e()],2):e._e()},Me=[],Re=g(De,Ne,Me,!1,null,"eada9cce",null,null);const Pe=Re.exports;class ke{constructor(){r(this,"_state");this._state={},this._state.tabs=[],this._state.views=[],this._state.file="",this._state.activeTab="",console.debug("OCA.Files.Sidebar initialized")}get state(){return this._state}registerTab(i){return this._state.tabs.findIndex(s=>s.id===i.id)>-1?(console.error("An tab with the same id ".concat(i.id," already exists"),i),!1):(this._state.tabs.push(i),!0)}registerSecondaryView(i){return this._state.views.findIndex(s=>s.id===i.id)>-1?(console.error("A similar view already exists",i),!1):(this._state.views.push(i),!0)}get file(){return this._state.file}setActiveTab(i){this._state.activeTab=i}}var m={exports:{}};const{XMLParser:ze,XMLValidator:Be}=ue,_=e=>{if(e==null||(e=e.toString().trim(),e.length===0)||Be.validate(e)!==!0)return!1;let i;const s=new ze;try{i=s.parse(e)}catch{return!1}return!(!i||!("svg"in i))};m.exports=_,m.exports.default=_;var Ue=m.exports;const qe=z(Ue),je=e=>new Promise(i=>{if(!He(e))i(e.toString("utf-8"));else{const s=new FileReader;s.onload=()=>{i(s.result)},s.readAsText(e)}}),He=e=>e.size!==void 0,Ve=async e=>{if(!e)throw new Error("Not an svg");let i="";if(B.isBuffer(e)||e instanceof File?i=await je(e):i=e,!qe(i))throw new Error("Not an svg");const s=document.createElement("div");s.innerHTML=i;const n=s.firstElementChild,o=!!Array.from(n.attributes).map(({name:a})=>a).find(a=>a.startsWith("on"));return n.getElementsByTagName("script").length===0&&!o?e:null};class Xe{constructor({id:i,name:s,icon:n,iconSvg:o,mount:a,setIsActive:l,update:b,destroy:v,enabled:f,scrollBottomReached:u}={}){r(this,"_id");r(this,"_name");r(this,"_icon");r(this,"_iconSvgSanitized");r(this,"_mount");r(this,"_setIsActive");r(this,"_update");r(this,"_destroy");r(this,"_enabled");r(this,"_scrollBottomReached");if(f===void 0&&(f=()=>!0),u===void 0&&(u=()=>{}),typeof i!="string"||i.trim()==="")throw new Error("The id argument is not a valid string");if(typeof s!="string"||s.trim()==="")throw new Error("The name argument is not a valid string");if((typeof n!="string"||n.trim()==="")&&typeof o!="string")throw new Error("Missing valid string for icon or iconSvg argument");if(typeof a!="function")throw new Error("The mount argument should be a function");if(l!==void 0&&typeof l!="function")throw new Error("The setIsActive argument should be a function");if(typeof b!="function")throw new Error("The update argument should be a function");if(typeof v!="function")throw new Error("The destroy argument should be a function");if(typeof f!="function")throw new Error("The enabled argument should be a function");if(typeof u!="function")throw new Error("The scrollBottomReached argument should be a function");this._id=i,this._name=s,this._icon=n,this._mount=a,this._setIsActive=l,this._update=b,this._destroy=v,this._enabled=f,this._scrollBottomReached=u,typeof o=="string"&&Ve(o).then(E=>{this._iconSvgSanitized=E})}get id(){return this._id}get name(){return this._name}get icon(){return this._icon}get iconSvg(){return this._iconSvgSanitized}get mount(){return this._mount}get setIsActive(){return this._setIsActive||(()=>{})}get update(){return this._update}get destroy(){return this._destroy}get enabled(){return this._enabled}get scrollBottomReached(){return this._scrollBottomReached}}p.prototype.t=d,window.OCA.Files||(window.OCA.Files={}),Object.assign(window.OCA.Files,{Sidebar:new ke}),Object.assign(window.OCA.Files.Sidebar,{Tab:Xe}),window.addEventListener("DOMContentLoaded",function(){const e=document.querySelector("body > .content")||document.querySelector("body > #content");if(e&&!document.getElementById("app-sidebar")){const n=document.createElement("div");n.id="app-sidebar",e.appendChild(n)}const i=p.extend(Pe),s=new i({name:"SidebarRoot"});s.$mount("#app-sidebar"),window.OCA.Files.Sidebar.open=s.open,window.OCA.Files.Sidebar.close=s.close,window.OCA.Files.Sidebar.setFullScreenMode=s.setFullScreenMode,window.OCA.Files.Sidebar.setShowTagsDefault=s.setShowTagsDefault});
