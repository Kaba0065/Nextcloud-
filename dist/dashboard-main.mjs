/*! third party licenses: dist/vendor.LICENSE.txt */
import"./chunks/modulepreload-polyfill-DGCCkazm.mjs";import{C as v,M as f,U as y,V as _,F as m,bO as r,a4 as w,am as k,bJ as d,bR as l,aH as n,bD as o,bQ as u,ao as S,bE as C}from"./core-common.mjs";import{d as x}from"./chunks/vuedraggable.umd-DmdzIPhs.mjs";import{n as b,r as W,P as N}from"./chunks/icons-BxSPavMS.mjs";import"./chunks/sortable.esm-CKUZvLoo.mjs";const A={data(){return{isMobile:this._isMobile()}},beforeMount(){window.addEventListener("resize",this._onResize)},beforeDestroy(){window.removeEventListener("resize",this._onResize)},methods:{_onResize(){this.isMobile=this._isMobile()},_isMobile(){return document.documentElement.clientWidth<768}}},I={name:"ApiDashboardWidget",components:{NcAvatar:v,NcDashboardWidget:f,NcDashboardWidgetItem:y,NcEmptyContent:_,NcButton:m,CheckIcon:W},props:{widget:{type:[Object,void 0],default:void 0},data:{type:[Object,void 0],default:void 0},loading:{type:Boolean,required:!0}},computed:{items(){var e,s;return(s=(e=this.data)==null?void 0:e.items)!=null?s:[]},emptyContentMessage(){var e,s;return(s=(e=this.data)==null?void 0:e.emptyContentMessage)!=null?s:""},halfEmptyContentMessage(){var e,s;return(s=(e=this.data)==null?void 0:e.halfEmptyContentMessage)!=null?s:""},newButton(){var e,s;return(s=(e=this.widget)==null?void 0:e.buttons)==null?void 0:s.find(a=>a.type==="new")},moreButton(){var e,s;return(s=(e=this.widget)==null?void 0:e.buttons)==null?void 0:s.find(a=>a.type==="more")},setupButton(){var e,s;return(s=(e=this.widget)==null?void 0:e.buttons)==null?void 0:s.find(a=>a.type==="setup")},showMoreLabel(){var e;return(e=this.moreButton)==null?void 0:e.text},showMoreUrl(){var e;return(e=this.moreButton)==null?void 0:e.link}}};var M=function(){var e=this,s=e._self._c;return s("NcDashboardWidget",{attrs:{items:e.items,"show-more-label":e.showMoreLabel,"show-more-url":e.showMoreUrl,loading:e.loading,"show-items-and-empty-content":!!e.halfEmptyContentMessage,"half-empty-content-message":e.halfEmptyContentMessage},scopedSlots:e._u([{key:"default",fn:function({item:a}){return[s("NcDashboardWidgetItem",{attrs:{"target-url":a.link,"overlay-icon-url":a.overlayIconUrl?a.overlayIconUrl:"","main-text":a.title,"sub-text":a.subtitle},scopedSlots:e._u([{key:"avatar",fn:function(){return[a.iconUrl?[s("NcAvatar",{attrs:{size:44,url:a.iconUrl}})]:e._e()]},proxy:!0}],null,!0)})]}},{key:"empty-content",fn:function(){return[e.items.length===0?s("NcEmptyContent",{attrs:{description:e.emptyContentMessage},scopedSlots:e._u([{key:"icon",fn:function(){return[e.emptyContentMessage?s("CheckIcon",{attrs:{size:65}}):e._e()]},proxy:!0},{key:"action",fn:function(){return[e.setupButton?s("NcButton",{attrs:{href:e.setupButton.link}},[e._v(" "+e._s(e.setupButton.text)+" ")]):e._e()]},proxy:!0}],null,!1,3234715105)}):e._e()]},proxy:!0}])})},O=[],D=b(I,M,O,!1,null,"fdf562af",null,null);const L=D.exports,h=r("dashboard","panels"),E=r("dashboard","firstRun"),B={weather:{text:t("dashboard","Weather"),icon:"icon-weather-status"},status:{text:t("dashboard","Status")}},P={name:"DashboardApp",components:{ApiDashboardWidget:L,NcButton:m,Draggable:x,NcModal:w,Pencil:N,NcUserStatusIcon:k},mixins:[A],data(){var e,s;return{isAdmin:d().isAdmin,timer:new Date,registeredStatus:[],callbacks:{},callbacksStatus:{},allCallbacksStatus:{},statusInfo:B,enabledStatuses:r("dashboard","statuses"),panels:h,firstRun:E,displayName:(e=d())==null?void 0:e.displayName,uid:(s=d())==null?void 0:s.uid,layout:r("dashboard","layout").filter(a=>h[a]),modal:!1,appStoreUrl:l("/settings/apps/dashboard"),statuses:{},apiWidgets:[],apiWidgetItems:{},loadingItems:!0}},computed:{greeting(){const e=this.timer.getHours();let s;e>=22||e<5?s="night":e>=18?s="evening":e>=12?s="afternoon":s="morning";const a={morning:{generic:t("dashboard","Good morning"),withName:t("dashboard","Good morning, {name}",{name:this.displayName},void 0,{escape:!1})},afternoon:{generic:t("dashboard","Good afternoon"),withName:t("dashboard","Good afternoon, {name}",{name:this.displayName},void 0,{escape:!1})},evening:{generic:t("dashboard","Good evening"),withName:t("dashboard","Good evening, {name}",{name:this.displayName},void 0,{escape:!1})},night:{generic:t("dashboard","Hello"),withName:t("dashboard","Hello, {name}",{name:this.displayName},void 0,{escape:!1})}};return{text:this.displayName&&this.uid!==this.displayName?a[s].withName:a[s].generic}},isActive(){return e=>this.layout.indexOf(e.id)>-1},isStatusActive(){return e=>!(e in this.enabledStatuses)||this.enabledStatuses[e]},sortedAllStatuses(){return Object.keys(this.allCallbacksStatus).slice().sort(this.sortStatuses)},sortedPanels(){return Object.values(this.panels).sort((e,s)=>{const a=this.layout.indexOf(e.id),i=this.layout.indexOf(s.id);return a===-1||i===-1?i-a||e.id-s.id:a-i||e.id-s.id})},sortedRegisteredStatus(){return this.registeredStatus.slice().sort(this.sortStatuses)}},watch:{callbacks(){this.rerenderPanels()},callbacksStatus(){for(const e in this.callbacksStatus){const s=this.$refs["status-"+e];this.statuses[e]&&this.statuses[e].mounted||(s?(this.callbacksStatus[e](s[0]),n.set(this.statuses,e,{mounted:!0})):console.error("Failed to register panel in the frontend as no backend data was provided for "+e))}}},async created(){await this.fetchApiWidgets();const e=Object.values(this.apiWidgets).filter(s=>this.isApiWidgetV2(s.id)).map(s=>s.id);await Promise.all(e.map(s=>this.fetchApiWidgetItems([s],!0)));for(const s of Object.values(this.apiWidgets))s.reload_interval>0&&setInterval(async()=>{await this.fetchApiWidgetItems([s.id],!0)},s.reload_interval*1e3)},mounted(){this.updateSkipLink(),window.addEventListener("scroll",this.handleScroll),setInterval(()=>{this.timer=new Date},3e4),this.firstRun&&window.addEventListener("scroll",this.disableFirstrunHint)},destroyed(){window.removeEventListener("scroll",this.handleScroll)},methods:{register(e,s){n.set(this.callbacks,e,s)},registerStatus(e,s){n.set(this.allCallbacksStatus,e,s),this.isStatusActive(e)&&(this.registeredStatus.push(e),this.$nextTick(()=>{n.set(this.callbacksStatus,e,s)}))},rerenderPanels(){for(const e in this.callbacks){if(this.isApiWidgetV2(this.panels[e].id))continue;const s=this.$refs[e];this.layout.indexOf(e)!==-1&&(this.panels[e]&&this.panels[e].mounted||(s?(this.callbacks[e](s[0],{widget:this.panels[e]}),n.set(this.panels[e],"mounted",!0)):console.error("Failed to register panel in the frontend as no backend data was provided for "+e)))}},saveLayout(){o.post(l("/apps/dashboard/layout"),{layout:this.layout.join(",")})},saveStatuses(){o.post(l("/apps/dashboard/statuses"),{statuses:JSON.stringify(this.enabledStatuses)})},showModal(){this.modal=!0,this.firstRun=!1},closeModal(){this.modal=!1},updateCheckbox(e,s){const a=this.layout.indexOf(e.id);!s&&a>-1?this.layout.splice(a,1):this.layout.push(e.id),n.set(this.panels[e.id],"mounted",!1),this.saveLayout(),this.$nextTick(()=>this.rerenderPanels())},disableFirstrunHint(){window.removeEventListener("scroll",this.disableFirstrunHint),setTimeout(()=>{this.firstRun=!1},1e3)},updateSkipLink(){document.getElementsByClassName("skip-navigation")[0].setAttribute("href","#app-dashboard")},updateStatusCheckbox(e,s){s?this.enableStatus(e):this.disableStatus(e)},enableStatus(e){this.enabledStatuses[e]=!0,this.registerStatus(e,this.allCallbacksStatus[e]),this.saveStatuses()},disableStatus(e){this.enabledStatuses[e]=!1;const s=this.registeredStatus.findIndex(a=>a===e);s!==-1&&(this.registeredStatus.splice(s,1),n.set(this.statuses,e,{mounted:!1}),this.$nextTick(()=>{n.delete(this.callbacksStatus,e)})),this.saveStatuses()},sortStatuses(e,s){const a=e.toLowerCase(),i=s.toLowerCase();return a>i?1:a<i?-1:0},handleScroll(){window.scrollY>70?document.body.classList.add("dashboard--scrolled"):document.body.classList.remove("dashboard--scrolled")},async fetchApiWidgets(){const e=await o.get(u("/apps/dashboard/api/v1/widgets"));this.apiWidgets=e.data.ocs.data},async fetchApiWidgetItems(e,s=!1){try{const a=u("/apps/dashboard/api/v2/widget-items"),i=new URLSearchParams(e.map(g=>["widgets[]",g])),c=(await o.get("".concat(a,"?").concat(i.toString()))).data.ocs.data;s?this.apiWidgetItems=Object.assign({},this.apiWidgetItems,c):this.apiWidgetItems=c}finally{this.loadingItems=!1}},isApiWidgetV2(e){for(const s of Object.values(this.apiWidgets))if(s.id===e&&s.item_api_versions.includes(2))return!0;return!1}}};var T=function(){var e=this,s=e._self._c;return s("div",{attrs:{id:"app-dashboard"}},[s("h2",[e._v(e._s(e.greeting.text))]),s("ul",{staticClass:"statuses"},e._l(e.sortedRegisteredStatus,function(a){return s("li",{key:a,attrs:{id:"status-"+a}},[s("div",{ref:"status-"+a,refInFor:!0})])}),0),s("Draggable",e._b({staticClass:"panels",attrs:{handle:".panel--header"},on:{end:e.saveLayout},model:{value:e.layout,callback:function(a){e.layout=a},expression:"layout"}},"Draggable",{swapThreshold:.3,delay:500,delayOnTouchOnly:!0,touchStartThreshold:3},!1),[e._l(e.layout,function(a){return[e.isApiWidgetV2(e.panels[a].id)?s("div",{key:"".concat(e.panels[a].id,"-v2"),staticClass:"panel"},[s("div",{staticClass:"panel--header"},[s("h2",[s("span",{class:e.apiWidgets[e.panels[a].id].icon_class,attrs:{"aria-labelledby":"panel-".concat(e.panels[a].id,"--header--icon--description"),"aria-hidden":"true",role:"img"}}),e._v(" "+e._s(e.apiWidgets[e.panels[a].id].title)+" ")]),s("span",{staticClass:"hidden-visually",attrs:{id:"panel-".concat(e.panels[a].id,"--header--icon--description")}},[e._v(" "+e._s(e.t("dashboard",'"{title} icon"',{title:e.apiWidgets[e.panels[a].id].title}))+" ")])]),s("div",{staticClass:"panel--content"},[s("ApiDashboardWidget",{attrs:{widget:e.apiWidgets[e.panels[a].id],data:e.apiWidgetItems[e.panels[a].id],loading:e.loadingItems}})],1)]):s("div",{key:e.panels[a].id,staticClass:"panel"},[s("div",{staticClass:"panel--header"},[s("h2",[s("span",{class:e.panels[a].iconClass,attrs:{"aria-labelledby":"panel-".concat(e.panels[a].id,"--header--icon--description"),"aria-hidden":"true",role:"img"}}),e._v(" "+e._s(e.panels[a].title)+" ")]),s("span",{staticClass:"hidden-visually",attrs:{id:"panel-".concat(e.panels[a].id,"--header--icon--description")}},[e._v(" "+e._s(e.t("dashboard",'"{title} icon"',{title:e.panels[a].title}))+" ")])]),s("div",{staticClass:"panel--content",class:{loading:!e.panels[a].mounted}},[s("div",{ref:e.panels[a].id,refInFor:!0,attrs:{"data-id":e.panels[a].id}})])])]})],2),s("div",{staticClass:"footer"},[s("NcButton",{on:{click:e.showModal},scopedSlots:e._u([{key:"icon",fn:function(){return[s("Pencil",{attrs:{size:20}})]},proxy:!0}])},[e._v(" "+e._s(e.t("dashboard","Customize"))+" ")])],1),e.modal?s("NcModal",{attrs:{size:"large"},on:{close:e.closeModal}},[s("div",{staticClass:"modal__content"},[s("h2",[e._v(e._s(e.t("dashboard","Edit widgets")))]),s("ol",{staticClass:"panels"},e._l(e.sortedAllStatuses,function(a){return s("li",{key:a,class:"panel-"+a},[s("input",{staticClass:"checkbox",attrs:{id:"status-checkbox-"+a,type:"checkbox"},domProps:{checked:e.isStatusActive(a)},on:{input:function(i){return e.updateStatusCheckbox(a,i.target.checked)}}}),s("label",{attrs:{for:"status-checkbox-"+a}},[a==="status"?s("NcUserStatusIcon",{attrs:{status:"online","aria-hidden":"true"}}):s("span",{class:e.statusInfo[a].icon,attrs:{"aria-hidden":"true"}}),e._v(" "+e._s(e.statusInfo[a].text)+" ")],1)])}),0),s("Draggable",e._b({staticClass:"panels",attrs:{tag:"ol",handle:".draggable"},on:{end:e.saveLayout},model:{value:e.layout,callback:function(a){e.layout=a},expression:"layout"}},"Draggable",{swapThreshold:.3,delay:500,delayOnTouchOnly:!0,touchStartThreshold:3},!1),e._l(e.sortedPanels,function(a){return s("li",{key:a.id,class:"panel-"+a.id},[s("input",{staticClass:"checkbox",attrs:{id:"panel-checkbox-"+a.id,type:"checkbox"},domProps:{checked:e.isActive(a)},on:{input:function(i){return e.updateCheckbox(a,i.target.checked)}}}),s("label",{class:{draggable:e.isActive(a)},attrs:{for:"panel-checkbox-"+a.id}},[s("span",{class:a.iconClass,attrs:{"aria-hidden":"true"}}),e._v(" "+e._s(a.title)+" ")])])}),0),e.isAdmin?s("a",{staticClass:"button",attrs:{href:e.appStoreUrl}},[e._v(e._s(e.t("dashboard","Get more widgets from the App Store")))]):e._e(),e.statuses.weather&&e.isStatusActive("weather")?s("div",[s("h2",[e._v(e._s(e.t("dashboard","Weather service")))]),s("p",[e._v(" "+e._s(e.t("dashboard","For your privacy, the weather data is requested by your Nextcloud server on your behalf so the weather service receives no personal information."))+" ")]),s("p",{staticClass:"credits--end"},[s("a",{attrs:{href:"https://api.met.no/doc/TermsOfService",target:"_blank",rel:"noopener"}},[e._v(e._s(e.t("dashboard","Weather data from Met.no")))]),e._v(", "),s("a",{attrs:{href:"https://wiki.osmfoundation.org/wiki/Privacy_Policy",target:"_blank",rel:"noopener"}},[e._v(e._s(e.t("dashboard","geocoding with Nominatim")))]),e._v(", "),s("a",{attrs:{href:"https://www.opentopodata.org/#public-api",target:"_blank",rel:"noopener"}},[e._v(e._s(e.t("dashboard","elevation data from OpenTopoData")))]),e._v(". ")])]):e._e()],1)]):e._e()],1)},$=[],R=b(P,T,$,!1,null,"8293d611",null,null);const U=R.exports;n.directive("Tooltip",S),n.prototype.t=C;const z=n.extend(U),p=new z({}).$mount("#app-content-vue");window.OCA.Dashboard={register:(e,s)=>p.register(e,s),registerStatus:(e,s)=>p.registerStatus(e,s)};
