/*! third party licenses: dist/vendor.LICENSE.txt */
import{bS as U,b as F,w as P,j as z,F as Q,K as B,a4 as R,a5 as V,aH as p,cO as Y,a6 as K,ad as C,aj as E,a2 as y,bE as l,bP as J,aM as X,X as Z,$ as T,C as ee,a8 as te,bJ as se,V as ae,c1 as k,c2 as D,L as ie,z as re,G as ne,bD as oe,bR as le,x as ue,H as de,e as ce,g as ge,o as pe,N as he}from"../core-common.mjs";import{V as me}from"./vue-local-storage-CaOJhnWT.mjs";import"./index-Ca0QcE7e.mjs";import{v as g,S as h}from"./toast-7xJhDYMn-BrG8uCqw.mjs";import{n as d,Y as j,m as fe,P as be,G as _e,au as we,ax as ye,ay as ve,am as Ue,az as Ce}from"./icons-BxSPavMS.mjs";import{a as Se}from"./index-Cf1NFlIs.mjs";import{l as w}from"./logger-DsZcYtCa.mjs";import{Y as m,J as f}from"./index-BLIV22dB.mjs";import"./index-DgCiVkaQ.mjs";import"./index-Biv1VH4I.mjs";const Ne={name:"GroupListItem",components:{AccountGroup:j,Delete:fe,Fragment:U,NcActionButton:F,NcActionInput:P,NcAppNavigationItem:z,NcButton:Q,NcCounterBubble:B,NcModal:R,NcNoteCard:V,Pencil:be},props:{active:{type:Boolean,required:!0},count:{type:Number,default:null},id:{type:String,required:!0},name:{type:String,required:!0}},data(){return{loadingRenameGroup:!1,openGroupMenu:!1,showRemoveGroupModal:!1}},computed:{settings(){return this.$store.getters.getServerData}},methods:{handleGroupMenuOpen(){this.openGroupMenu=!0},async renameGroup(e){if(e.trim()==="")return;const s=this.$refs.displayNameInput.$el.querySelector('input[type="text"]').value;if(s.trim()!=="")try{this.openGroupMenu=!1,this.loadingRenameGroup=!0,await this.$store.dispatch("renameGroup",{groupid:e.trim(),displayName:s.trim()}),this.loadingRenameGroup=!1}catch{this.openGroupMenu=!0,this.loadingRenameGroup=!1}},async removeGroup(){try{await this.$store.dispatch("removeGroup",this.id),this.showRemoveGroupModal=!1}catch{g(t("settings",'Failed to remove group "{group}"',{group:this.name}))}}}};var Ae=function(){var e=this,s=e._self._c;return s("Fragment",[e.showRemoveGroupModal?s("NcModal",{on:{close:function(a){e.showRemoveGroupModal=!1}}},[s("div",{staticClass:"modal__content"},[s("h2",{staticClass:"modal__header"},[e._v(" "+e._s(e.t("settings","Please confirm the group removal"))+" ")]),s("NcNoteCard",{attrs:{type:"warning","show-alert":""}},[e._v(" "+e._s(e.t("settings",'You are about to remove the group "{group}". The users will NOT be deleted.',{group:e.name}))+" ")]),s("div",{staticClass:"modal__button-row"},[s("NcButton",{attrs:{type:"secondary"},on:{click:function(a){e.showRemoveGroupModal=!1}}},[e._v(" "+e._s(e.t("settings","Cancel"))+" ")]),s("NcButton",{attrs:{type:"primary"},on:{click:e.removeGroup}},[e._v(" "+e._s(e.t("settings","Confirm"))+" ")])],1)],1)]):e._e(),s("NcAppNavigationItem",{key:e.id,attrs:{exact:!0,name:e.name,to:{name:"group",params:{selectedGroup:encodeURIComponent(e.id)}},loading:e.loadingRenameGroup,"menu-open":e.openGroupMenu},on:{"update:menuOpen":e.handleGroupMenuOpen},scopedSlots:e._u([{key:"icon",fn:function(){return[s("AccountGroup",{attrs:{size:20}})]},proxy:!0},{key:"counter",fn:function(){return[e.count?s("NcCounterBubble",{attrs:{type:e.active?"highlighted":void 0}},[e._v(" "+e._s(e.count)+" ")]):e._e()]},proxy:!0},{key:"actions",fn:function(){return[e.id!=="admin"&&e.id!=="disabled"&&e.settings.isAdmin?s("NcActionInput",{ref:"displayNameInput",attrs:{"trailing-button-label":e.t("settings","Submit"),type:"text",value:e.name,label:e.t("settings","Rename group")},on:{submit:function(a){return e.renameGroup(e.id)}},scopedSlots:e._u([{key:"icon",fn:function(){return[s("Pencil",{attrs:{size:20}})]},proxy:!0}],null,!1,580569589)}):e._e(),e.id!=="admin"&&e.id!=="disabled"&&e.settings.isAdmin?s("NcActionButton",{on:{click:function(a){e.showRemoveGroupModal=!0}},scopedSlots:e._u([{key:"icon",fn:function(){return[s("Delete",{attrs:{size:20}})]},proxy:!0}],null,!1,2705356561)},[e._v(" "+e._s(e.t("settings","Remove group"))+" ")]):e._e()]},proxy:!0}])})],1)},Ge=[],Le=d(Ne,Ae,Ge,!1,null,"c7801fa4",null,null);const xe=Le.exports;p.directive("elementVisibility",Y);const v=3,qe=p.extend({name:"VirtualList",props:{dataComponent:{type:[Object,Function],required:!0},dataKey:{type:String,required:!0},dataSources:{type:Array,required:!0},itemHeight:{type:Number,required:!0},extraProps:{type:Object,default:()=>({})}},data(){return{bufferItems:v,index:0,headerHeight:0,tableHeight:0,resizeObserver:null}},computed:{startIndex(){return Math.max(0,this.index-v)},shownItems(){return Math.ceil((this.tableHeight-this.headerHeight)/this.itemHeight)+v*2},renderedItems(){return this.dataSources.slice(this.startIndex,this.startIndex+this.shownItems)},tbodyStyle(){const e=this.startIndex+this.shownItems>this.dataSources.length,s=this.dataSources.length-this.startIndex-this.shownItems,a=Math.min(this.dataSources.length-this.startIndex,s);return{paddingTop:"".concat(this.startIndex*this.itemHeight,"px"),paddingBottom:e?0:"".concat(a*this.itemHeight,"px")}}},mounted(){var e,s;const a=this.$el,i=(e=this.$refs)==null?void 0:e.tfoot,n=(s=this.$refs)==null?void 0:s.thead;this.resizeObserver=new ResizeObserver(Se.debounce(()=>{var o,r;this.headerHeight=(o=n==null?void 0:n.clientHeight)!=null?o:0,this.tableHeight=(r=a==null?void 0:a.clientHeight)!=null?r:0,w.debug("VirtualList resizeObserver updated"),this.onScroll()},100,!1)),this.resizeObserver.observe(a),this.resizeObserver.observe(i),this.resizeObserver.observe(n),this.$el.addEventListener("scroll",this.onScroll)},beforeDestroy(){this.resizeObserver&&this.resizeObserver.disconnect()},methods:{handleFooterVisibility(e){e&&this.$emit("scroll-end")},onScroll(){this.index=Math.max(0,Math.round(this.$el.scrollTop/this.itemHeight))}}});var $e=function(){var e=this,s=e._self._c;return e._self._setupProxy,s("table",{staticClass:"user-list"},[e._t("before"),s("thead",{ref:"thead",staticClass:"user-list__header",attrs:{role:"rowgroup"}},[e._t("header")],2),s("tbody",{staticClass:"user-list__body",style:e.tbodyStyle},e._l(e.renderedItems,function(a,i){return s(e.dataComponent,e._b({key:a[e.dataKey],tag:"component",attrs:{user:a,visible:(i>=e.bufferItems||e.index<=e.bufferItems)&&i<e.shownItems-e.bufferItems}},"component",e.extraProps,!1))}),1),s("tfoot",{directives:[{name:"element-visibility",rawName:"v-element-visibility",value:e.handleFooterVisibility,expression:"handleFooterVisibility"}],ref:"tfoot",staticClass:"user-list__footer",attrs:{role:"rowgroup"}},[e._t("footer")],2)],2)},Oe=[],Me=d(qe,$e,Oe,!1,null,"782954d7",null,null);const ke=Me.exports,De={name:"NewUserModal",components:{NcButton:Q,NcModal:R,NcPasswordField:K,NcSelect:C,NcTextField:E},props:{loading:{type:Object,required:!0},newUser:{type:Object,required:!0},quotaOptions:{type:Array,required:!0}},data(){return{possibleManagers:[],managerLabel:t("settings","Set user manager")}},computed:{showConfig(){return this.$store.getters.getShowConfig},settings(){return this.$store.getters.getServerData},usernameLabel(){return this.settings.newUserGenerateUserID?t("settings","Username will be autogenerated"):t("settings","Username (required)")},minPasswordLength(){return this.$store.getters.getPasswordPolicyMinLength},groups(){return this.$store.getters.getGroups.filter(e=>e.id!=="disabled").sort((e,s)=>e.name.localeCompare(s.name))},subAdminsGroups(){return this.$store.getters.getSubadminGroups},canAddGroups(){return this.groups.map(e=>(e=Object.assign({},e),e.$isDisabled=e.canAdd===!1,e))},languages(){return[{name:t("settings","Common languages"),languages:this.settings.languages.commonLanguages},...this.settings.languages.commonLanguages,{name:t("settings","Other languages"),languages:this.settings.languages.otherLanguages},...this.settings.languages.otherLanguages]}},async beforeMount(){await this.searchUserManager()},methods:{async createUser(){var e,s,a,i,n,o,r,S,N,A,b,G,L,x,q,$,_,O;this.loading.all=!0;try{await this.$store.dispatch("addUser",{userid:this.newUser.id,password:this.newUser.password,displayName:this.newUser.displayName,email:this.newUser.mailAddress,groups:this.newUser.groups.map(c=>c.id),subadmin:this.newUser.subAdminsGroups.map(c=>c.id),quota:this.newUser.quota.id,language:this.newUser.language.code,manager:this.newUser.manager.id}),this.$emit("reset"),(o=(n=(i=(a=(s=(e=this.$refs.username)==null?void 0:e.$refs)==null?void 0:s.inputField)==null?void 0:a.$refs)==null?void 0:i.input)==null?void 0:n.focus)==null||o.call(n),this.$emit("close")}catch(c){if(this.loading.all=!1,c.response&&c.response.data&&c.response.data.ocs&&c.response.data.ocs.meta){const M=c.response.data.ocs.meta.statuscode;M===102?(G=(b=(A=(N=(S=(r=this.$refs.username)==null?void 0:r.$refs)==null?void 0:S.inputField)==null?void 0:N.$refs)==null?void 0:A.input)==null?void 0:b.focus)==null||G.call(b):M===107&&((O=(_=($=(q=(x=(L=this.$refs.password)==null?void 0:L.$refs)==null?void 0:x.inputField)==null?void 0:q.$refs)==null?void 0:$.input)==null?void 0:_.focus)==null||O.call(_))}}},handleGroupInput(e){this.newUser.groups=e.filter(s=>!!s.id)},async createGroup({name:e}){this.loading.groups=!0;try{await this.$store.dispatch("addGroup",e),this.newUser.groups.push(this.groups.find(s=>s.id===e)),this.loading.groups=!1}catch{this.loading.groups=!1}},validateQuota(e){const s=OC.Util.computerFileSize(e);return s!==null&&s>=0?(e=OC.Util.humanFileSize(OC.Util.computerFileSize(e)),this.newUser.quota={id:e,label:e},this.newUser.quota):(this.newUser.quota=this.quotaOptions[0],this.quotaOptions[0])},languageFilterBy(e,s,a){return e.languages?e.languages.some(({name:i})=>i.toLocaleLowerCase().includes(a.toLocaleLowerCase())):(s||"").toLocaleLowerCase().includes(a.toLocaleLowerCase())},async searchUserManager(e){await this.$store.dispatch("searchUsers",{offset:0,limit:10,search:e}).then(s=>{const a=s!=null&&s.data?Object.values(s==null?void 0:s.data.ocs.data.users):[];a.length>0&&(this.possibleManagers=a)})}}};var Ie=function(){var e=this,s=e._self._c;return s("NcModal",e._g({staticClass:"modal",attrs:{size:"small"}},e.$listeners),[s("form",{staticClass:"modal__form",attrs:{"data-test":"form",disabled:e.loading.all},on:{submit:function(a){return a.preventDefault(),e.createUser.apply(null,arguments)}}},[s("h2",[e._v(e._s(e.t("settings","New user")))]),s("NcTextField",{ref:"username",staticClass:"modal__item",attrs:{"data-test":"username",value:e.newUser.id,disabled:e.settings.newUserGenerateUserID,label:e.usernameLabel,autocapitalize:"none",autocomplete:"off",spellcheck:"false",pattern:"[a-zA-Z0-9 _\\.@\\-']+",required:""},on:{"update:value":function(a){return e.$set(e.newUser,"id",a)}}}),s("NcTextField",{staticClass:"modal__item",attrs:{"data-test":"displayName",value:e.newUser.displayName,label:e.t("settings","Display name"),autocapitalize:"none",autocomplete:"off",spellcheck:"false"},on:{"update:value":function(a){return e.$set(e.newUser,"displayName",a)}}}),e.settings.newUserRequireEmail?e._e():s("span",{staticClass:"modal__hint",attrs:{id:"password-email-hint"}},[e._v(" "+e._s(e.t("settings","Either password or email is required"))+" ")]),s("NcPasswordField",{ref:"password",staticClass:"modal__item",attrs:{"data-test":"password",value:e.newUser.password,minlength:e.minPasswordLength,maxlength:469,"aria-describedby":"password-email-hint",label:e.newUser.mailAddress===""?e.t("settings","Password (required)"):e.t("settings","Password"),autocapitalize:"none",autocomplete:"new-password",spellcheck:"false",required:e.newUser.mailAddress===""},on:{"update:value":function(a){return e.$set(e.newUser,"password",a)}}}),s("NcTextField",{staticClass:"modal__item",attrs:{"data-test":"email",type:"email",value:e.newUser.mailAddress,"aria-describedby":"password-email-hint",label:e.newUser.password===""||e.settings.newUserRequireEmail?e.t("settings","Email (required)"):e.t("settings","Email"),autocapitalize:"none",autocomplete:"off",spellcheck:"false",required:e.newUser.password===""||e.settings.newUserRequireEmail},on:{"update:value":function(a){return e.$set(e.newUser,"mailAddress",a)}}}),s("div",{staticClass:"modal__item"},[e.settings.isAdmin?e._e():s("NcTextField",{class:{"icon-loading-small":e.loading.groups},attrs:{id:"new-user-groups-input",tabindex:"-1",value:e.newUser.groups,required:!e.settings.isAdmin}}),s("label",{staticClass:"modal__label",attrs:{for:"new-user-groups"}},[e._v(" "+e._s(e.settings.isAdmin?e.t("settings","Groups"):e.t("settings","Groups (required)"))+" ")]),s("NcSelect",{staticClass:"modal__select",attrs:{"input-id":"new-user-groups",placeholder:e.t("settings","Set user groups"),disabled:e.loading.groups||e.loading.all,options:e.canAddGroups,value:e.newUser.groups,label:"name","close-on-select":!1,multiple:!0,taggable:!0},on:{input:e.handleGroupInput,"option:created":e.createGroup}})],1),e.subAdminsGroups.length>0&&e.settings.isAdmin?s("div",{staticClass:"modal__item"},[s("label",{staticClass:"modal__label",attrs:{for:"new-user-sub-admin"}},[e._v(" "+e._s(e.t("settings","Administered groups"))+" ")]),s("NcSelect",{staticClass:"modal__select",attrs:{"input-id":"new-user-sub-admin",placeholder:e.t("settings","Set user as admin for …"),options:e.subAdminsGroups,"close-on-select":!1,multiple:!0,label:"name"},model:{value:e.newUser.subAdminsGroups,callback:function(a){e.$set(e.newUser,"subAdminsGroups",a)},expression:"newUser.subAdminsGroups"}})],1):e._e(),s("div",{staticClass:"modal__item"},[s("label",{staticClass:"modal__label",attrs:{for:"new-user-quota"}},[e._v(" "+e._s(e.t("settings","Quota"))+" ")]),s("NcSelect",{staticClass:"modal__select",attrs:{"input-id":"new-user-quota",placeholder:e.t("settings","Set user quota"),options:e.quotaOptions,clearable:!1,taggable:!0,"create-option":e.validateQuota},model:{value:e.newUser.quota,callback:function(a){e.$set(e.newUser,"quota",a)},expression:"newUser.quota"}})],1),e.showConfig.showLanguages?s("div",{staticClass:"modal__item"},[s("label",{staticClass:"modal__label",attrs:{for:"new-user-language"}},[e._v(" "+e._s(e.t("settings","Language"))+" ")]),s("NcSelect",{staticClass:"modal__select",attrs:{"input-id":"new-user-language",placeholder:e.t("settings","Set default language"),clearable:!1,selectable:a=>!a.languages,"filter-by":e.languageFilterBy,options:e.languages,label:"name"},model:{value:e.newUser.language,callback:function(a){e.$set(e.newUser,"language",a)},expression:"newUser.language"}})],1):e._e(),s("div",{class:["modal__item managers",{"icon-loading-small":e.loading.manager}]},[s("label",{staticClass:"modal__label",attrs:{for:"new-user-manager"}},[e._v(" "+e._s(e.t("settings","Manager"))+" ")]),s("NcSelect",{staticClass:"modal__select",attrs:{"input-id":"new-user-manager",placeholder:e.managerLabel,options:e.possibleManagers,"user-select":!0,label:"displayname"},on:{search:e.searchUserManager},model:{value:e.newUser.manager,callback:function(a){e.$set(e.newUser,"manager",a)},expression:"newUser.manager"}})],1),s("NcButton",{staticClass:"modal__submit",attrs:{"data-test":"submit",type:"primary","native-type":"submit"}},[e._v(" "+e._s(e.t("settings","Add new user"))+" ")])],1)])},Fe=[],Pe=d(De,Ie,Fe,!1,null,"89c33491",null,null);const ze=Pe.exports,Qe=p.extend({name:"UserListFooter",components:{NcLoadingIcon:y},props:{loading:{type:Boolean,required:!0},filteredUsers:{type:Array,required:!0}},computed:{userCount(){return this.loading?this.n("settings","{userCount} user …","{userCount} users …",this.filteredUsers.length,{userCount:this.filteredUsers.length}):this.n("settings","{userCount} user","{userCount} users",this.filteredUsers.length,{userCount:this.filteredUsers.length})}},methods:{t:l,n:J}});var Be=function(){var e=this,s=e._self._c;return e._self._setupProxy,s("tr",{staticClass:"footer"},[s("th",{attrs:{scope:"row"}},[s("span",{staticClass:"hidden-visually"},[e._v(e._s(e.t("settings","Total rows summary")))])]),s("td",{staticClass:"footer__cell footer__cell--loading"},[e.loading?s("NcLoadingIcon",{attrs:{title:e.t("settings","Loading users …"),size:32}}):e._e()],1),s("td",{staticClass:"footer__cell footer__cell--count footer__cell--multiline"},[s("span",{attrs:{"aria-describedby":"user-count-desc"}},[e._v(e._s(e.userCount))]),s("span",{staticClass:"hidden-visually",attrs:{id:"user-count-desc"}},[e._v(" "+e._s(e.t("settings","Scroll to load more rows"))+" ")])])])},Re=[],Ee=d(Qe,Be,Re,!1,null,"d2bd9c96",null,null);const Te=Ee.exports,je=p.extend({name:"UserListHeader",props:{hasObfuscated:{type:Boolean,required:!0}},computed:{showConfig(){return this.$store.getters.getShowConfig},settings(){return this.$store.getters.getServerData},subAdminsGroups(){return this.$store.getters.getSubadminGroups},passwordLabel(){return this.hasObfuscated?l("settings","Password or insufficient permissions message"):l("settings","Password")}},methods:{t:l}});var He=function(){var e=this,s=e._self._c;return e._self._setupProxy,s("tr",{staticClass:"header"},[s("th",{staticClass:"header__cell header__cell--avatar",attrs:{"data-cy-user-list-header-avatar":"",scope:"col"}},[s("span",{staticClass:"hidden-visually"},[e._v(" "+e._s(e.t("settings","Avatar"))+" ")])]),s("th",{staticClass:"header__cell header__cell--displayname",attrs:{"data-cy-user-list-header-displayname":"",scope:"col"}},[s("strong",[e._v(" "+e._s(e.t("settings","Display name"))+" ")]),s("span",{staticClass:"header__subtitle"},[e._v(" "+e._s(e.t("settings","Username"))+" ")])]),s("th",{staticClass:"header__cell",class:{"header__cell--obfuscated":e.hasObfuscated},attrs:{"data-cy-user-list-header-password":"",scope:"col"}},[s("span",[e._v(e._s(e.passwordLabel))])]),s("th",{staticClass:"header__cell",attrs:{"data-cy-user-list-header-email":"",scope:"col"}},[s("span",[e._v(e._s(e.t("settings","Email")))])]),s("th",{staticClass:"header__cell header__cell--large",attrs:{"data-cy-user-list-header-groups":"",scope:"col"}},[s("span",[e._v(e._s(e.t("settings","Groups")))])]),e.subAdminsGroups.length>0&&e.settings.isAdmin?s("th",{staticClass:"header__cell header__cell--large",attrs:{"data-cy-user-list-header-subadmins":"",scope:"col"}},[s("span",[e._v(e._s(e.t("settings","Group admin for")))])]):e._e(),s("th",{staticClass:"header__cell",attrs:{"data-cy-user-list-header-quota":"",scope:"col"}},[s("span",[e._v(e._s(e.t("settings","Quota")))])]),e.showConfig.showLanguages?s("th",{staticClass:"header__cell header__cell--large",attrs:{"data-cy-user-list-header-languages":"",scope:"col"}},[s("span",[e._v(e._s(e.t("settings","Language")))])]):e._e(),e.showConfig.showUserBackend||e.showConfig.showStoragePath?s("th",{staticClass:"header__cell header__cell--large",attrs:{"data-cy-user-list-header-storage-location":"",scope:"col"}},[e.showConfig.showUserBackend?s("span",[e._v(" "+e._s(e.t("settings","User backend"))+" ")]):e._e(),e.showConfig.showStoragePath?s("span",{staticClass:"header__subtitle"},[e._v(" "+e._s(e.t("settings","Storage location"))+" ")]):e._e()]):e._e(),e.showConfig.showLastLogin?s("th",{staticClass:"header__cell",attrs:{"data-cy-user-list-header-last-login":"",scope:"col"}},[s("span",[e._v(e._s(e.t("settings","Last login")))])]):e._e(),s("th",{staticClass:"header__cell header__cell--large header__cell--fill",attrs:{"data-cy-user-list-header-manager":"",scope:"col"}},[s("span",[e._v(e._s(e.t("settings","Manager")))])]),s("th",{staticClass:"header__cell header__cell--actions",attrs:{"data-cy-user-list-header-actions":"",scope:"col"}},[s("span",{staticClass:"hidden-visually"},[e._v(" "+e._s(e.t("settings","User actions"))+" ")])])])},We=[],Ve=d(je,He,We,!1,null,"3a05e70c",null,null);const Ye=Ve.exports,Ke=X({components:{NcActionButton:F,NcActions:Z,NcIconSvgWrapper:T},props:{actions:{type:Array,required:!0},disabled:{type:Boolean,required:!0},edit:{type:Boolean,required:!0},user:{type:Object,required:!0}},computed:{editSvg(){return this.edit?_e:we}},methods:{toggleEdit(){this.$emit("update:edit",!this.edit)}}});var Je=function(){var e=this,s=e._self._c;return e._self._setupProxy,s("NcActions",{attrs:{"aria-label":e.t("settings","Toggle user actions menu"),disabled:e.disabled,inline:1}},[s("NcActionButton",{attrs:{"data-cy-user-list-action-toggle-edit":"".concat(e.edit),disabled:e.disabled},on:{click:e.toggleEdit},scopedSlots:e._u([{key:"icon",fn:function(){return[s("NcIconSvgWrapper",{key:e.editSvg,attrs:{svg:e.editSvg,"aria-hidden":"true"}})]},proxy:!0}])},[e._v(" "+e._s(e.edit?e.t("settings","Done"):e.t("settings","Edit"))+" ")]),e._l(e.actions,function({action:a,icon:i,text:n},o){return s("NcActionButton",{key:o,attrs:{disabled:e.disabled,"aria-label":n,icon:i},on:{click:r=>a(r,{...e.user})}},[e._v(" "+e._s(n)+" ")])})],2)},Xe=[],Ze=d(Ke,Je,Xe,!1,null,null,null,null);const et=Ze.exports,tt={props:{user:{type:Object,required:!0},settings:{type:Object,default:()=>({})},groups:{type:Array,default:()=>[]},subAdminsGroups:{type:Array,default:()=>[]},quotaOptions:{type:Array,default:()=>[]},languages:{type:Array,required:!0},externalActions:{type:Array,default:()=>[]}},computed:{showConfig(){return this.$store.getters.getShowConfig},userGroups(){return this.groups.filter(e=>this.user.groups.includes(e.id))},userSubAdminsGroups(){return this.subAdminsGroups.filter(e=>this.user.subadmin.includes(e.id))},availableGroups(){return this.groups.map(e=>{const s=Object.assign({},e);return s.$isDisabled=e.canAdd===!1&&!this.user.groups.includes(e.id)||e.canRemove===!1&&this.user.groups.includes(e.id),s})},usedSpace(){return this.user.quota.used?t("settings","{size} used",{size:OC.Util.humanFileSize(this.user.quota.used)}):t("settings","{size} used",{size:OC.Util.humanFileSize(0)})},usedQuota(){let e=this.user.quota.quota;return e>0?e=Math.min(100,Math.round(this.user.quota.used/e*100)):e=95*(1-1/(this.user.quota.used/(10*Math.pow(2,30))+1)),isNaN(e)?0:e},userQuota(){if(this.user.quota.quota>=0){const e=OC.Util.humanFileSize(this.user.quota.quota);return this.quotaOptions.find(s=>s.id===e)||{id:e,label:e}}else if(this.user.quota.quota==="default")return this.quotaOptions[0];return this.quotaOptions[1]},minPasswordLength(){return this.$store.getters.getPasswordPolicyMinLength},userLanguage(){const e=this.languages[0].languages.concat(this.languages[1].languages).find(s=>s.code===this.user.language);return typeof e!="object"&&this.user.language!==""?{code:this.user.language,name:this.user.language}:this.user.language===""?!1:e},userLastLoginTooltip(){return this.user.lastLogin>0?OC.Util.formatDate(this.user.lastLogin):""},userLastLogin(){return this.user.lastLogin>0?OC.Util.relativeModifiedDate(this.user.lastLogin):t("settings","Never")}}},u={id:"none",label:t("settings","Unlimited")},H={id:"default",label:t("settings","Default quota")},W=e=>{const s=Object.keys(e);return s.length===1&&s.at(0)==="id"},st={name:"UserRow",components:{NcAvatar:ee,NcLoadingIcon:y,NcProgressBar:te,NcSelect:C,NcTextField:E,UserRowActions:et},mixins:[tt],props:{user:{type:Object,required:!0},visible:{type:Boolean,required:!0},users:{type:Array,required:!0},hasObfuscated:{type:Boolean,required:!0},groups:{type:Array,default:()=>[]},subAdminsGroups:{type:Array,required:!0},quotaOptions:{type:Array,required:!0},languages:{type:Array,required:!0},settings:{type:Object,required:!0},externalActions:{type:Array,default:()=>[]}},data(){var e;return{selectedQuota:!1,rand:Math.random().toString(36).substring(2),loadingPossibleManagers:!1,possibleManagers:[],currentManager:"",editing:!1,loading:{all:!1,displayName:!1,password:!1,mailAddress:!1,groups:!1,subadmins:!1,quota:!1,delete:!1,disable:!1,languages:!1,wipe:!1,manager:!1},editedDisplayName:this.user.displayname,editedPassword:"",editedMail:(e=this.user.email)!=null?e:""}},computed:{managerLabel(){return t("settings","Set user manager")},isObfuscated(){return W(this.user)},showConfig(){return this.$store.getters.getShowConfig},isLoadingUser(){return this.loading.delete||this.loading.disable||this.loading.wipe},isLoadingField(){return this.loading.delete||this.loading.disable||this.loading.all},uniqueId(){return encodeURIComponent(this.user.id+this.rand)},userGroupsLabels(){return this.userGroups.map(e=>e.name).join(", ")},userSubAdminsGroupsLabels(){return this.userSubAdminsGroups.map(e=>e.name).join(", ")},usedSpace(){var e,s;return(e=this.user.quota)!=null&&e.used?t("settings","{size} used",{size:m((s=this.user.quota)==null?void 0:s.used)}):t("settings","{size} used",{size:m(0)})},canEdit(){return se().uid!==this.user.id||this.settings.isAdmin},userQuota(){var s;let e=(s=this.user.quota)==null?void 0:s.quota;return e==="default"&&(e=this.settings.defaultQuota,e!=="none"&&(e=f(e,!0))),e==="none"||e===-3?t("settings","Unlimited"):e>=0?m(e):m(0)},userActions(){const e=[{icon:"icon-delete",text:t("settings","Delete user"),action:this.deleteUser},{icon:"icon-delete",text:t("settings","Wipe all devices"),action:this.wipeUserDevices},{icon:this.user.enabled?"icon-close":"icon-add",text:this.user.enabled?t("settings","Disable user"):t("settings","Enable user"),action:this.enableDisableUser}];return this.user.email!==null&&this.user.email!==""&&e.push({icon:"icon-mail",text:t("settings","Resend welcome email"),action:this.sendWelcomeMail}),e.concat(this.externalActions)},editedUserQuota:{get(){return this.selectedQuota!==!1?this.selectedQuota:this.settings.defaultQuota!==u.id&&f(this.settings.defaultQuota,!0)>=0?{id:this.settings.defaultQuota,label:this.settings.defaultQuota}:u},set(e){this.selectedQuota=e}},availableLanguages(){return this.languages[0].languages.concat(this.languages[1].languages)}},async beforeMount(){this.user.manager&&await this.initManager(this.user.manager)},methods:{wipeUserDevices(){const e=this.user.id;OC.dialogs.confirmDestructive(t("settings","In case of lost device or exiting the organization, this can remotely wipe the Nextcloud data from all devices associated with {userid}. Only works if the devices are connected to the internet.",{userid:e}),t("settings","Remote wipe of devices"),{type:OC.dialogs.YES_NO_BUTTONS,confirm:t("settings","Wipe {userid}'s devices",{userid:e}),confirmClasses:"error",cancel:t("settings","Cancel")},s=>{s&&(this.loading.wipe=!0,this.loading.all=!0,this.$store.dispatch("wipeUserDevices",e).then(()=>h(t("settings","Wiped {userid}'s devices",{userid:e})),{timeout:2e3}).finally(()=>{this.loading.wipe=!1,this.loading.all=!1}))},!0)},filterManagers(e){return e.filter(s=>s.id!==this.user.id)},async initManager(e){await this.$store.dispatch("getUser",e).then(s=>{this.currentManager=s==null?void 0:s.data.ocs.data})},async searchInitialUserManager(){this.loadingPossibleManagers=!0,await this.searchUserManager(),this.loadingPossibleManagers=!1},async searchUserManager(e){await this.$store.dispatch("searchUsers",{offset:0,limit:10,search:e}).then(s=>{const a=s!=null&&s.data?this.filterManagers(Object.values(s==null?void 0:s.data.ocs.data.users)):[];a.length>0&&(this.possibleManagers=a)})},async updateUserManager(e){e===null&&(this.currentManager=""),this.loading.manager=!0;try{await this.$store.dispatch("setUserData",{userid:this.user.id,key:"manager",value:this.currentManager?this.currentManager.id:""})}catch(s){g(t("setting","Failed to update user manager")),console.error(s)}finally{this.loading.manager=!1}},deleteUser(){const e=this.user.id;OC.dialogs.confirmDestructive(t("settings","Fully delete {userid}'s account including all their personal files, app data, etc.",{userid:e}),t("settings","Account deletion"),{type:OC.dialogs.YES_NO_BUTTONS,confirm:t("settings","Delete {userid}'s account",{userid:e}),confirmClasses:"error",cancel:t("settings","Cancel")},s=>{if(s)return this.loading.delete=!0,this.loading.all=!0,this.$store.dispatch("deleteUser",e).then(()=>{this.loading.delete=!1,this.loading.all=!1})},!0)},enableDisableUser(){this.loading.delete=!0,this.loading.all=!0;const e=this.user.id,s=!this.user.enabled;return this.$store.dispatch("enableDisableUser",{userid:e,enabled:s}).then(()=>{this.loading.delete=!1,this.loading.all=!1})},updateDisplayName(){this.loading.displayName=!0,this.$store.dispatch("setUserData",{userid:this.user.id,key:"displayname",value:this.editedDisplayName}).then(()=>{this.loading.displayName=!1,this.editedDisplayName===this.user.displayname&&h(t("setting","Display name was successfully changed"))})},updatePassword(){this.loading.password=!0,this.editedPassword.length===0?(g(t("setting","Password can't be empty")),this.loading.password=!1):this.$store.dispatch("setUserData",{userid:this.user.id,key:"password",value:this.editedPassword}).then(()=>{this.loading.password=!1,this.editedPassword="",h(t("setting","Password was successfully changed"))})},updateEmail(){this.loading.mailAddress=!0,this.editedMail===""?(g(t("setting","Email can't be empty")),this.loading.mailAddress=!1,this.editedMail=this.user.email):this.$store.dispatch("setUserData",{userid:this.user.id,key:"email",value:this.editedMail}).then(()=>{this.loading.mailAddress=!1,this.editedMail===this.user.email&&h(t("setting","Email was successfully changed"))})},async createGroup({name:e}){this.loading={groups:!0,subadmins:!0};try{await this.$store.dispatch("addGroup",e);const s=this.user.id;await this.$store.dispatch("addUserGroup",{userid:s,gid:e})}catch(s){console.error(s)}finally{this.loading={groups:!1,subadmins:!1}}return this.$store.getters.getGroups[this.groups.length]},async addUserGroup(e){if(e.isCreating)return;this.loading.groups=!0;const s=this.user.id,a=e.id;if(e.canAdd===!1)return!1;try{await this.$store.dispatch("addUserGroup",{userid:s,gid:a})}catch(i){console.error(i)}finally{this.loading.groups=!1}},async removeUserGroup(e){if(e.canRemove===!1)return!1;this.loading.groups=!0;const s=this.user.id,a=e.id;try{await this.$store.dispatch("removeUserGroup",{userid:s,gid:a}),this.loading.groups=!1,this.$route.params.selectedGroup===a&&this.$store.commit("deleteUser",s)}catch{this.loading.groups=!1}},async addUserSubAdmin(e){this.loading.subadmins=!0;const s=this.user.id,a=e.id;try{await this.$store.dispatch("addUserSubAdmin",{userid:s,gid:a}),this.loading.subadmins=!1}catch(i){console.error(i)}},async removeUserSubAdmin(e){this.loading.subadmins=!0;const s=this.user.id,a=e.id;try{await this.$store.dispatch("removeUserSubAdmin",{userid:s,gid:a})}catch(i){console.error(i)}finally{this.loading.subadmins=!1}},async setUserQuota(e="none"){e==="none"&&(e=u),this.loading.quota=!0,e=e.id?e.id:e;try{const s=(f(e,!0)||e).toString();await this.$store.dispatch("setUserData",{userid:this.user.id,key:"quota",value:s})}catch(s){console.error(s)}finally{this.loading.quota=!1}return e},validateQuota(e){return typeof e=="object"&&(e=(e==null?void 0:e.id)||e.label),f(e,!0)===null?u:(e=m(f(e,!0)),{id:e,label:e})},async setUserLanguage(e){this.loading.languages=!0;try{await this.$store.dispatch("setUserData",{userid:this.user.id,key:"language",value:e.code}),this.loading.languages=!1}catch(s){console.error(s)}return e},sendWelcomeMail(){this.loading.all=!0,this.$store.dispatch("sendWelcomeMail",this.user.id).then(()=>h(t("setting","Welcome mail sent!"),{timeout:2e3})).finally(()=>{this.loading.all=!1})},async toggleEdit(){var e,s,a,i,n,o;this.editing=!this.editing,this.editing&&(await this.$nextTick(),(n=(i=(a=(s=(e=this.$refs.displayNameField)==null?void 0:e.$refs)==null?void 0:s.inputField)==null?void 0:a.$refs)==null?void 0:i.input)==null||n.focus()),this.editedDisplayName!==this.user.displayname?this.editedDisplayName=this.user.displayname:this.editedMail!==this.user.email&&(this.editedMail=(o=this.user.email)!=null?o:"")}}};var at=function(){var a,i,n,o;var e=this,s=e._self._c;return s("tr",{staticClass:"user-list__row",attrs:{"data-cy-user-row":e.user.id}},[s("td",{staticClass:"row__cell row__cell--avatar",attrs:{"data-cy-user-list-cell-avatar":""}},[e.isLoadingUser?s("NcLoadingIcon",{attrs:{name:e.t("settings","Loading user …"),size:32}}):e.visible?s("NcAvatar",{attrs:{"disable-menu":"","show-user-status":!1,user:e.user.id}}):e._e()],1),s("td",{staticClass:"row__cell row__cell--displayname",attrs:{"data-cy-user-list-cell-displayname":""}},[e.editing&&e.user.backendCapabilities.setDisplayName?[s("NcTextField",{ref:"displayNameField",staticClass:"user-row-text-field",class:{"icon-loading-small":e.loading.displayName},attrs:{"data-cy-user-list-input-displayname":"","data-loading":e.loading.displayName||void 0,"trailing-button-label":e.t("settings","Submit"),"show-trailing-button":!0,disabled:e.loading.displayName||e.isLoadingField,label:e.t("settings","Change display name"),"trailing-button-icon":"arrowRight",value:e.editedDisplayName,autocapitalize:"off",autocomplete:"off",spellcheck:"false"},on:{"update:value":function(r){e.editedDisplayName=r},"trailing-button-click":e.updateDisplayName}})]:[e.isObfuscated?e._e():s("strong",{attrs:{title:((a=e.user.displayname)==null?void 0:a.length)>20?e.user.displayname:null}},[e._v(" "+e._s(e.user.displayname)+" ")]),s("span",{staticClass:"row__subtitle"},[e._v(e._s(e.user.id))])]],2),s("td",{staticClass:"row__cell",class:{"row__cell--obfuscated":e.hasObfuscated},attrs:{"data-cy-user-list-cell-password":""}},[e.editing&&e.settings.canChangePassword&&e.user.backendCapabilities.setPassword?[s("NcTextField",{staticClass:"user-row-text-field",class:{"icon-loading-small":e.loading.password},attrs:{"data-cy-user-list-input-password":"","data-loading":e.loading.password||void 0,"trailing-button-label":e.t("settings","Submit"),"show-trailing-button":!0,disabled:e.loading.password||e.isLoadingField,minlength:e.minPasswordLength,maxlength:"469",label:e.t("settings","Set new password"),"trailing-button-icon":"arrowRight",value:e.editedPassword,autocapitalize:"off",autocomplete:"new-password",required:"",spellcheck:"false",type:"password"},on:{"update:value":function(r){e.editedPassword=r},"trailing-button-click":e.updatePassword}})]:e.isObfuscated?s("span",[e._v(" "+e._s(e.t("settings","You do not have permissions to see the details of this user"))+" ")]):e._e()],2),s("td",{staticClass:"row__cell",attrs:{"data-cy-user-list-cell-email":""}},[e.editing?[s("NcTextField",{staticClass:"user-row-text-field",class:{"icon-loading-small":e.loading.mailAddress},attrs:{"data-cy-user-list-input-email":"","data-loading":e.loading.mailAddress||void 0,"show-trailing-button":!0,"trailing-button-label":e.t("settings","Submit"),label:e.t("settings","Set new email address"),disabled:e.loading.mailAddress||e.isLoadingField,"trailing-button-icon":"arrowRight",value:e.editedMail,autocapitalize:"off",autocomplete:"email",spellcheck:"false",type:"email"},on:{"update:value":function(r){e.editedMail=r},"trailing-button-click":e.updateEmail}})]:e.isObfuscated?e._e():s("span",{attrs:{title:((i=e.user.email)==null?void 0:i.length)>20?e.user.email:null}},[e._v(" "+e._s(e.user.email)+" ")])],2),s("td",{staticClass:"row__cell row__cell--large row__cell--multiline",attrs:{"data-cy-user-list-cell-groups":""}},[e.editing?[s("label",{staticClass:"hidden-visually",attrs:{for:"groups"+e.uniqueId}},[e._v(" "+e._s(e.t("settings","Add user to group"))+" ")]),s("NcSelect",{attrs:{"data-cy-user-list-input-groups":"","data-loading":e.loading.groups||void 0,"input-id":"groups"+e.uniqueId,"close-on-select":!1,disabled:e.isLoadingField,loading:e.loading.groups,multiple:!0,"append-to-body":!1,options:e.availableGroups,placeholder:e.t("settings","Add user to group"),taggable:e.settings.isAdmin,value:e.userGroups,label:"name","no-wrap":!0,"create-option":r=>({name:r,isCreating:!0})},on:{"option:created":e.createGroup,"option:selected":r=>e.addUserGroup(r.at(-1)),"option:deselected":e.removeUserGroup}})]:e.isObfuscated?e._e():s("span",{attrs:{title:((n=e.userGroupsLabels)==null?void 0:n.length)>40?e.userGroupsLabels:null}},[e._v(" "+e._s(e.userGroupsLabels)+" ")])],2),e.subAdminsGroups.length>0&&e.settings.isAdmin?s("td",{staticClass:"row__cell row__cell--large row__cell--multiline",attrs:{"data-cy-user-list-cell-subadmins":""}},[e.editing&&e.settings.isAdmin&&e.subAdminsGroups.length>0?[s("label",{staticClass:"hidden-visually",attrs:{for:"subadmins"+e.uniqueId}},[e._v(" "+e._s(e.t("settings","Set user as admin for"))+" ")]),s("NcSelect",{attrs:{"data-cy-user-list-input-subadmins":"","data-loading":e.loading.subadmins||void 0,"input-id":"subadmins"+e.uniqueId,"close-on-select":!1,disabled:e.isLoadingField,loading:e.loading.subadmins,label:"name","append-to-body":!1,multiple:!0,"no-wrap":!0,options:e.subAdminsGroups,placeholder:e.t("settings","Set user as admin for"),value:e.userSubAdminsGroups},on:{"option:deselected":e.removeUserSubAdmin,"option:selected":r=>e.addUserSubAdmin(r.at(-1))}})]:e.isObfuscated?e._e():s("span",{attrs:{title:((o=e.userSubAdminsGroupsLabels)==null?void 0:o.length)>40?e.userSubAdminsGroupsLabels:null}},[e._v(" "+e._s(e.userSubAdminsGroupsLabels)+" ")])],2):e._e(),s("td",{staticClass:"row__cell",attrs:{"data-cy-user-list-cell-quota":""}},[e.editing?[s("label",{staticClass:"hidden-visually",attrs:{for:"quota"+e.uniqueId}},[e._v(" "+e._s(e.t("settings","Select user quota"))+" ")]),s("NcSelect",{attrs:{"close-on-select":!0,"create-option":e.validateQuota,"data-cy-user-list-input-quota":"","data-loading":e.loading.quota||void 0,disabled:e.isLoadingField,loading:e.loading.quota,"append-to-body":!1,clearable:!1,"input-id":"quota"+e.uniqueId,options:e.quotaOptions,placeholder:e.t("settings","Select user quota"),taggable:!0},on:{"option:selected":e.setUserQuota},model:{value:e.editedUserQuota,callback:function(r){e.editedUserQuota=r},expression:"editedUserQuota"}})]:e.isObfuscated?e._e():[s("span",{attrs:{id:"quota-progress"+e.uniqueId}},[e._v(e._s(e.userQuota)+" ("+e._s(e.usedSpace)+")")]),s("NcProgressBar",{staticClass:"row__progress",class:{"row__progress--warn":e.usedQuota>80},attrs:{"aria-labelledby":"quota-progress"+e.uniqueId,value:e.usedQuota}})]],2),e.showConfig.showLanguages?s("td",{staticClass:"row__cell row__cell--large",attrs:{"data-cy-user-list-cell-language":""}},[e.editing?[s("label",{staticClass:"hidden-visually",attrs:{for:"language"+e.uniqueId}},[e._v(" "+e._s(e.t("settings","Set the language"))+" ")]),s("NcSelect",{attrs:{id:"language"+e.uniqueId,"data-cy-user-list-input-language":"","data-loading":e.loading.languages||void 0,"allow-empty":!1,disabled:e.isLoadingField,loading:e.loading.languages,clearable:!1,"append-to-body":!1,options:e.availableLanguages,placeholder:e.t("settings","No language set"),value:e.userLanguage,label:"name"},on:{input:e.setUserLanguage}})]:e.isObfuscated?e._e():s("span",[e._v(" "+e._s(e.userLanguage.name)+" ")])],2):e._e(),e.showConfig.showUserBackend||e.showConfig.showStoragePath?s("td",{staticClass:"row__cell row__cell--large",attrs:{"data-cy-user-list-cell-storage-location":""}},[e.isObfuscated?e._e():[e.showConfig.showUserBackend?s("span",[e._v(e._s(e.user.backend))]):e._e(),e.showConfig.showStoragePath?s("span",{staticClass:"row__subtitle",attrs:{title:e.user.storageLocation}},[e._v(" "+e._s(e.user.storageLocation)+" ")]):e._e()]],2):e._e(),e.showConfig.showLastLogin?s("td",{staticClass:"row__cell",attrs:{title:e.userLastLoginTooltip,"data-cy-user-list-cell-last-login":""}},[e.isObfuscated?e._e():s("span",[e._v(e._s(e.userLastLogin))])]):e._e(),s("td",{staticClass:"row__cell row__cell--large row__cell--fill",attrs:{"data-cy-user-list-cell-manager":""}},[e.editing?[s("label",{staticClass:"hidden-visually",attrs:{for:"manager"+e.uniqueId}},[e._v(" "+e._s(e.managerLabel)+" ")]),s("NcSelect",{staticClass:"select--fill",attrs:{"data-cy-user-list-input-manager":"","data-loading":e.loading.manager||void 0,"input-id":"manager"+e.uniqueId,"close-on-select":!0,disabled:e.isLoadingField,"append-to-body":!1,loading:e.loadingPossibleManagers||e.loading.manager,label:"displayname",options:e.possibleManagers,placeholder:e.managerLabel},on:{open:e.searchInitialUserManager,search:e.searchUserManager,"option:selected":e.updateUserManager},model:{value:e.currentManager,callback:function(r){e.currentManager=r},expression:"currentManager"}})]:e.isObfuscated?e._e():s("span",[e._v(" "+e._s(e.user.manager)+" ")])],2),s("td",{staticClass:"row__cell row__cell--actions",attrs:{"data-cy-user-list-cell-actions":""}},[e.visible&&!e.isObfuscated&&e.canEdit&&!e.loading.all?s("UserRowActions",{attrs:{actions:e.userActions,disabled:e.isLoadingField,edit:e.editing,user:e.user},on:{"update:edit":e.toggleEdit}}):e._e()],1)])},it=[],rt=d(st,at,it,!1,null,"22f66041",null,null);const nt=rt.exports,ot='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 16 16"><path d="M10 1C8.25 1 7 2.43 7 3.8c0 1.4.1 2.4.8 3.5.2.29.5.35.7.6.135.5.24 1 .1 1.5-.28.1-.525.22-.8.33-.085-.15-.23-.2-.47-.4C6.6 8.89 5.77 8.58 5 8.29c-.1-.37-.1-.65 0-1 .156-.166.37-.27.5-.43.46-.6.5-1.654.5-2.37 0-1.06-.954-1.9-2-1.9-1.17 0-2 1-2 1.9 0 .93.034 1.64.5 2.37.13.2.367.26.5.43.1.33.1.654 0 1-.85.3-1.6.64-2.34 1.04-.57.4-.52.205-.66 1.53-.11 1.06 2.335 1.13 4 1.13h.17c-.054.274-.1.63-.17 1.3-.16 1.59 3.5 1.7 6 1.7s6.16-.1 6-1.7c-.215-2-.23-1.71-1-2.3-1.1-.654-2.45-1.17-3.6-1.6-.15-.56-.04-.97.1-1.5.235-.25.5-.36.7-.6.7-.885.8-2.425.8-3.5 0-1.6-1.43-2.8-3-2.8z"/></svg>',I={id:"",displayName:"",password:"",mailAddress:"",groups:[],manager:"",subAdminsGroups:[],quota:H,language:{code:"en",name:t("settings","Default language")}},lt={name:"UserList",components:{Fragment:U,NcEmptyContent:ae,NcIconSvgWrapper:T,NcLoadingIcon:y,NewUserModal:ze,UserListFooter:Te,UserListHeader:Ye,VirtualList:ke},props:{selectedGroup:{type:String,default:null},externalActions:{type:Array,default:()=>[]}},data(){return{UserRow:nt,loading:{all:!1,groups:!1,users:!1},isInitialLoad:!0,rowHeight:55,usersSvg:ot,searchQuery:"",newUser:Object.assign({},I)}},computed:{showConfig(){return this.$store.getters.getShowConfig},settings(){return this.$store.getters.getServerData},style(){return{"--row-height":"".concat(this.rowHeight,"px")}},hasObfuscated(){return this.filteredUsers.some(e=>W(e))},users(){return this.$store.getters.getUsers},filteredUsers(){return this.selectedGroup==="disabled"?this.users.filter(e=>e.enabled===!1):this.settings.isAdmin?this.users.filter(e=>e.enabled!==!1):this.users.filter(e=>e.enabled!==!1)},groups(){return this.$store.getters.getGroups.filter(e=>e.id!=="disabled").sort((e,s)=>e.name.localeCompare(s.name))},subAdminsGroups(){return this.$store.getters.getSubadminGroups},quotaOptions(){const e=this.settings.quotaPreset.reduce((s,a)=>s.concat({id:a,label:a}),[]);return this.settings.allowUnlimitedQuota&&e.unshift(u),e.unshift(H),e},usersOffset(){return this.$store.getters.getUsersOffset},usersLimit(){return this.$store.getters.getUsersLimit},disabledUsersOffset(){return this.$store.getters.getDisabledUsersOffset},disabledUsersLimit(){return this.$store.getters.getDisabledUsersLimit},usersCount(){return this.users.length},languages(){return[{label:t("settings","Common languages"),languages:this.settings.languages.commonLanguages},{label:t("settings","Other languages"),languages:this.settings.languages.otherLanguages}]}},watch:{async selectedGroup(e,s){this.isInitialLoad=!0,await this.redirectIfDisabled(),this.$store.commit("resetUsers"),await this.loadUsers(),this.setNewUserDefaultGroup(e)},filteredUsers(e){w.debug("".concat(e.length," filtered user(s)"))}},async created(){await this.loadUsers()},async mounted(){this.settings.canChangePassword||OC.Notification.showTemporary(t("settings","Password change is disabled because the master key is disabled")),this.resetForm(),k("nextcloud:unified-search.search",this.search),k("nextcloud:unified-search.reset",this.resetSearch),await this.redirectIfDisabled()},beforeDestroy(){D("nextcloud:unified-search.search",this.search),D("nextcloud:unified-search.reset",this.resetSearch)},methods:{async handleScrollEnd(){await this.loadUsers()},async loadUsers(){this.loading.users=!0;try{this.selectedGroup==="disabled"?await this.$store.dispatch("getDisabledUsers",{offset:this.disabledUsersOffset,limit:this.disabledUsersLimit}):await this.$store.dispatch("getUsers",{offset:this.usersOffset,limit:this.usersLimit,group:this.selectedGroup,search:this.searchQuery}),w.debug("".concat(this.users.length," total user(s) loaded"))}catch(e){w.error("Failed to load users",{error:e}),g("Failed to load users")}this.loading.users=!1,this.isInitialLoad=!1},closeModal(){this.$store.commit("setShowConfig",{key:"showNewUserForm",value:!1})},async search({query:e}){this.searchQuery=e,this.$store.commit("resetUsers"),await this.loadUsers()},resetSearch(){this.search({query:""})},resetForm(){this.newUser=Object.assign({},I),this.settings.defaultLanguage&&p.set(this.newUser.language,"code",this.settings.defaultLanguage),this.setNewUserDefaultGroup(this.selectedGroup),this.loading.all=!1},setNewUserDefaultGroup(e){if(e&&e.length>0){const s=this.groups.find(a=>a.id===e);if(s){this.newUser.groups=[s];return}}this.newUser.groups=[]},async redirectIfDisabled(){const e=this.$store.getters.getGroups;this.selectedGroup==="disabled"&&e.findIndex(s=>s.id==="disabled"&&s.usercount===0)>-1&&(this.$router.push({name:"users"}),await this.loadUsers())}}};var ut=function(){var e=this,s=e._self._c;return s("Fragment",[e.showConfig.showNewUserForm?s("NewUserModal",{attrs:{loading:e.loading,"new-user":e.newUser,"quota-options":e.quotaOptions},on:{reset:e.resetForm,close:e.closeModal}}):e._e(),e.filteredUsers.length===0?s("NcEmptyContent",{staticClass:"empty",attrs:{name:e.isInitialLoad&&e.loading.users?null:e.t("settings","No users")},scopedSlots:e._u([{key:"icon",fn:function(){return[e.isInitialLoad&&e.loading.users?s("NcLoadingIcon",{attrs:{name:e.t("settings","Loading users …"),size:64}}):s("NcIconSvgWrapper",{attrs:{svg:e.usersSvg}})]},proxy:!0}],null,!1,934871631)}):s("VirtualList",{style:e.style,attrs:{"data-component":e.UserRow,"data-sources":e.filteredUsers,"data-key":"id","data-cy-user-list":"","item-height":e.rowHeight,"extra-props":{users:e.users,settings:e.settings,hasObfuscated:e.hasObfuscated,groups:e.groups,subAdminsGroups:e.subAdminsGroups,quotaOptions:e.quotaOptions,languages:e.languages,externalActions:e.externalActions}},on:{"scroll-end":e.handleScrollEnd},scopedSlots:e._u([{key:"before",fn:function(){return[s("caption",{staticClass:"hidden-visually"},[e._v(" "+e._s(e.t("settings","List of users. This list is not fully rendered for performance reasons. The users will be rendered as you navigate through the list."))+" ")])]},proxy:!0},{key:"header",fn:function(){return[s("UserListHeader",{attrs:{"has-obfuscated":e.hasObfuscated}})]},proxy:!0},{key:"footer",fn:function(){return[s("UserListFooter",{attrs:{loading:e.loading.users,"filtered-users":e.filteredUsers}})]},proxy:!0}])})],1)},dt=[],ct=d(lt,ut,dt,!1,null,"83dfbc87",null,null);const gt=ct.exports,pt={name:"UserSettingsDialog",components:{NcAppSettingsDialog:ie,NcAppSettingsSection:re,NcCheckboxRadioSwitch:ne,NcSelect:C},props:{open:{type:Boolean,required:!0}},data(){return{selectedQuota:!1,loadingSendMail:!1}},computed:{isModalOpen:{get(){return this.open},set(e){this.$emit("update:open",e)}},showConfig(){return this.$store.getters.getShowConfig},settings(){return this.$store.getters.getServerData},showLanguages:{get(){return this.getLocalstorage("showLanguages")},set(e){this.setLocalStorage("showLanguages",e)}},showLastLogin:{get(){return this.getLocalstorage("showLastLogin")},set(e){this.setLocalStorage("showLastLogin",e)}},showUserBackend:{get(){return this.getLocalstorage("showUserBackend")},set(e){this.setLocalStorage("showUserBackend",e)}},showStoragePath:{get(){return this.getLocalstorage("showStoragePath")},set(e){this.setLocalStorage("showStoragePath",e)}},quotaOptions(){const e=this.settings.quotaPreset.reduce((s,a)=>s.concat({id:a,label:a}),[]);return this.settings.allowUnlimitedQuota&&e.unshift(u),e},defaultQuota:{get(){return this.selectedQuota!==!1?this.selectedQuota:this.settings.defaultQuota!==u.id&&OC.Util.computerFileSize(this.settings.defaultQuota)>=0?{id:this.settings.defaultQuota,label:this.settings.defaultQuota}:u},set(e){this.selectedQuota=e}},sendWelcomeMail:{get(){return this.settings.newUserSendEmail},async set(e){try{this.loadingSendMail=!0,this.$store.commit("setServerData",{...this.settings,newUserSendEmail:e}),await oe.post(le("/settings/users/preferences/newUser.sendEmail"),{value:e?"yes":"no"})}catch(s){console.error("could not update newUser.sendEmail preference: "+s.message,s)}finally{this.loadingSendMail=!1}}}},methods:{getLocalstorage(e){const s=this.$localStorage.get(e);return this.$store.commit("setShowConfig",{key:e,value:s!==null?s==="true":this.showConfig[e]}),this.showConfig[e]},setLocalStorage(e,s){return this.$store.commit("setShowConfig",{key:e,value:s}),this.$localStorage.set(e,s),s},validateQuota(e){return typeof e=="object"&&(e=(e==null?void 0:e.id)||e.label),OC.Util.computerFileSize(e)===null?u:(e=OC.Util.humanFileSize(OC.Util.computerFileSize(e)),{id:e,label:e})},setDefaultQuota(e="none"){e==="none"&&(e=u),this.$store.dispatch("setAppConfig",{app:"files",key:"default_quota",value:e.id?e.id:e}).then(()=>{typeof e!="object"&&(e={id:e,label:e}),this.defaultQuota=e})}}};var ht=function(){var e=this,s=e._self._c;return s("NcAppSettingsDialog",{attrs:{open:e.isModalOpen,"show-navigation":!0,name:e.t("settings","User management settings")},on:{"update:open":function(a){e.isModalOpen=a}}},[s("NcAppSettingsSection",{attrs:{id:"visibility-settings",name:e.t("settings","Visibility")}},[s("NcCheckboxRadioSwitch",{attrs:{type:"switch","data-test":"showLanguages",checked:e.showLanguages},on:{"update:checked":function(a){e.showLanguages=a}}},[e._v(" "+e._s(e.t("settings","Show language"))+" ")]),s("NcCheckboxRadioSwitch",{attrs:{type:"switch","data-test":"showUserBackend",checked:e.showUserBackend},on:{"update:checked":function(a){e.showUserBackend=a}}},[e._v(" "+e._s(e.t("settings","Show user backend"))+" ")]),s("NcCheckboxRadioSwitch",{attrs:{type:"switch","data-test":"showStoragePath",checked:e.showStoragePath},on:{"update:checked":function(a){e.showStoragePath=a}}},[e._v(" "+e._s(e.t("settings","Show storage path"))+" ")]),s("NcCheckboxRadioSwitch",{attrs:{type:"switch","data-test":"showLastLogin",checked:e.showLastLogin},on:{"update:checked":function(a){e.showLastLogin=a}}},[e._v(" "+e._s(e.t("settings","Show last login"))+" ")])],1),s("NcAppSettingsSection",{attrs:{id:"email-settings",name:e.t("settings","Send email")}},[s("NcCheckboxRadioSwitch",{attrs:{type:"switch","data-test":"sendWelcomeMail",checked:e.sendWelcomeMail,disabled:e.loadingSendMail},on:{"update:checked":function(a){e.sendWelcomeMail=a}}},[e._v(" "+e._s(e.t("settings","Send welcome email to new users"))+" ")])],1),s("NcAppSettingsSection",{attrs:{id:"default-settings",name:e.t("settings","Defaults")}},[s("label",{attrs:{for:"default-quota-select"}},[e._v(e._s(e.t("settings","Default quota")))]),s("NcSelect",{attrs:{"input-id":"default-quota-select",placement:"top",taggable:!0,options:e.quotaOptions,"create-option":e.validateQuota,placeholder:e.t("settings","Select default quota"),clearable:!1},on:{"option:selected":e.setDefaultQuota},model:{value:e.defaultQuota,callback:function(a){e.defaultQuota=a},expression:"defaultQuota"}})],1)],1)},mt=[],ft=d(pt,ht,mt,!1,null,"815c1fb6",null,null);const bt=ft.exports;p.use(me);const _t={name:"Users",components:{AccountGroup:j,AccountOff:ye,Cog:ve,Fragment:U,GroupListItem:xe,NcActionInput:P,NcActionText:ue,NcAppContent:de,NcAppNavigation:ce,NcAppNavigationCaption:ge,NcAppNavigationItem:z,NcAppNavigationNew:pe,NcContent:he,NcCounterBubble:B,NcLoadingIcon:y,Plus:Ue,ShieldAccount:Ce,UserList:gt,UserSettingsDialog:bt},props:{selectedGroup:{type:String,default:null}},data(){return{externalActions:[],newGroupName:"",isAddGroupOpen:!1,loadingAddGroup:!1,hasAddGroupError:!1,isDialogOpen:!1}},computed:{pageHeading(){var e;return this.selectedGroupDecoded===null?l("settings","Active users"):(e={admin:l("settings","Admins"),disabled:l("settings","Disabled users")}[this.selectedGroupDecoded])!=null?e:l("settings","User group: {group}",{group:this.selectedGroupDecoded})},showConfig(){return this.$store.getters.getShowConfig},selectedGroupDecoded(){return this.selectedGroup?decodeURIComponent(this.selectedGroup):null},users(){return this.$store.getters.getUsers},groups(){return this.$store.getters.getGroups},usersOffset(){return this.$store.getters.getUsersOffset},usersLimit(){return this.$store.getters.getUsersLimit},userCount(){return this.$store.getters.getUserCount},settings(){return this.$store.getters.getServerData},groupList(){return(Array.isArray(this.groups)?this.groups:[]).filter(e=>e.id!=="disabled"&&e.id!=="admin").map(e=>this.formatGroupMenu(e))},adminGroupMenu(){return this.formatGroupMenu(this.groups.find(e=>e.id==="admin"))},disabledGroupMenu(){return this.formatGroupMenu(this.groups.find(e=>e.id==="disabled"))}},beforeMount(){this.$store.commit("initGroups",{groups:this.$store.getters.getServerData.groups,orderBy:this.$store.getters.getServerData.sortGroups,userCount:this.$store.getters.getServerData.userCount}),this.$store.dispatch("getPasswordPolicyMinLength")},created(){Object.assign(OCA,{Settings:{UserList:{registerAction:this.registerAction}}})},methods:{t:l,showNewUserMenu(){this.$store.commit("setShowConfig",{key:"showNewUserForm",value:!0})},registerAction(e,s,a){return this.externalActions.push({icon:e,text:s,action:a}),this.externalActions},async createGroup(){this.hasAddGroupError=!1;const e=this.newGroupName.trim();if(e===""){this.hasAddGroupError=!0;return}this.isAddGroupOpen=!1,this.loadingAddGroup=!0;try{await this.$store.dispatch("addGroup",e),await this.$router.push({name:"group",params:{selectedGroup:encodeURIComponent(e)}}),this.newGroupName=""}catch{g(l("settings","Failed to create group"))}this.loadingAddGroup=!1},formatGroupMenu(e){const s={};return typeof e>"u"?{}:(s.id=e.id,s.title=e.name,s.usercount=e.usercount,e.usercount-e.disabled>0&&(s.count=e.usercount-e.disabled),s)}}};var wt=function(){var e=this,s=e._self._c;return s("Fragment",[s("NcContent",{attrs:{"app-name":"settings"}},[s("NcAppNavigation",{attrs:{"aria-label":e.t("settings","User management")},scopedSlots:e._u([{key:"list",fn:function(){return[s("NcAppNavigationItem",{attrs:{id:"everyone",exact:!0,name:e.t("settings","Active users"),to:{name:"users"}},scopedSlots:e._u([{key:"icon",fn:function(){return[s("AccountGroup",{attrs:{size:20}})]},proxy:!0},{key:"counter",fn:function(){return[e.userCount?s("NcCounterBubble",{attrs:{type:e.selectedGroupDecoded?void 0:"highlighted"}},[e._v(" "+e._s(e.userCount)+" ")]):e._e()]},proxy:!0}])}),e.settings.isAdmin?s("NcAppNavigationItem",{attrs:{id:"admin",exact:!0,name:e.t("settings","Admins"),to:{name:"group",params:{selectedGroup:"admin"}}},scopedSlots:e._u([{key:"icon",fn:function(){return[s("ShieldAccount",{attrs:{size:20}})]},proxy:!0},e.adminGroupMenu.count>0?{key:"counter",fn:function(){return[s("NcCounterBubble",{attrs:{type:e.selectedGroupDecoded==="admin"?"highlighted":void 0}},[e._v(" "+e._s(e.adminGroupMenu.count)+" ")])]},proxy:!0}:null],null,!0)}):e._e(),e.disabledGroupMenu.usercount>0||e.disabledGroupMenu.usercount===-1?s("NcAppNavigationItem",{attrs:{id:"disabled",exact:!0,name:e.t("settings","Disabled users"),to:{name:"group",params:{selectedGroup:"disabled"}}},scopedSlots:e._u([{key:"icon",fn:function(){return[s("AccountOff",{attrs:{size:20}})]},proxy:!0},e.disabledGroupMenu.usercount>0?{key:"counter",fn:function(){return[s("NcCounterBubble",{attrs:{type:e.selectedGroupDecoded==="disabled"?"highlighted":void 0}},[e._v(" "+e._s(e.disabledGroupMenu.usercount)+" ")])]},proxy:!0}:null],null,!0)}):e._e(),s("NcAppNavigationCaption",{attrs:{name:e.t("settings","Groups"),disabled:e.loadingAddGroup,"aria-label":e.loadingAddGroup?e.t("settings","Creating group …"):e.t("settings","Create group"),"force-menu":"",open:e.isAddGroupOpen},on:{"update:open":function(a){e.isAddGroupOpen=a}},scopedSlots:e._u([{key:"actionsTriggerIcon",fn:function(){return[e.loadingAddGroup?s("NcLoadingIcon"):s("Plus",{attrs:{size:20}})]},proxy:!0},{key:"actions",fn:function(){return[s("NcActionText",{scopedSlots:e._u([{key:"icon",fn:function(){return[s("AccountGroup",{attrs:{size:20}})]},proxy:!0}])},[e._v(" "+e._s(e.t("settings","Create group"))+" ")]),s("NcActionInput",{attrs:{label:e.t("settings","Group name"),"data-cy-settings-new-group-name":"","label-outside":!1,disabled:e.loadingAddGroup,value:e.newGroupName,error:e.hasAddGroupError,"helper-text":e.hasAddGroupError?e.t("settings","Please enter a valid group name"):""},on:{"update:value":function(a){e.newGroupName=a},submit:e.createGroup}})]},proxy:!0}])}),e._l(e.groupList,function(a){return s("GroupListItem",{key:a.id,attrs:{id:a.id,active:e.selectedGroupDecoded===a.id,name:a.title,count:a.count}})})]},proxy:!0},{key:"footer",fn:function(){return[s("ul",{staticClass:"app-navigation-entry__settings"},[s("NcAppNavigationItem",{attrs:{name:e.t("settings","User management settings")},on:{click:function(a){e.isDialogOpen=!0}},scopedSlots:e._u([{key:"icon",fn:function(){return[s("Cog",{attrs:{size:20}})]},proxy:!0}])})],1)]},proxy:!0}])},[s("NcAppNavigationNew",{attrs:{"button-id":"new-user-button",text:e.t("settings","New user")},on:{click:e.showNewUserMenu,keyup:[function(a){return!a.type.indexOf("key")&&e._k(a.keyCode,"enter",13,a.key,"Enter")?null:e.showNewUserMenu.apply(null,arguments)},function(a){return!a.type.indexOf("key")&&e._k(a.keyCode,"space",32,a.key,[" ","Spacebar"])?null:e.showNewUserMenu.apply(null,arguments)}]},scopedSlots:e._u([{key:"icon",fn:function(){return[s("Plus",{attrs:{size:20}})]},proxy:!0}])})],1),s("NcAppContent",{attrs:{"page-heading":e.pageHeading}},[s("UserList",{attrs:{"selected-group":e.selectedGroupDecoded,"external-actions":e.externalActions}})],1)],1),s("UserSettingsDialog",{attrs:{open:e.isDialogOpen},on:{"update:open":function(a){e.isDialogOpen=a}}})],1)},yt=[],vt=d(_t,wt,yt,!1,null,"94311423",null,null);const Ot=vt.exports;export{Ot as default};
