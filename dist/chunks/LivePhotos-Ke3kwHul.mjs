/*! third party licenses: dist/vendor.LICENSE.txt */
import{bE as r,aH as b,bC as M,b_ as x}from"../core-common.mjs";import{p as u}from"./index-Ca0QcE7e.mjs";import{M as F,b as R}from"./index-D0tJKDfW.mjs";import{N as E,Q as A,R as T,b as j,u as k,e as C,s as D,v as N,i as B}from"./index-BLIV22dB.mjs";import{d as V,e as L}from"./icons-BxSPavMS.mjs";import{P as S}from"./index-BqikPZjc.mjs";import{l as w}from"./logger-CMIEMPjA.mjs";import{g as I}from"./fileUtils-pqLuXd9u.mjs";import{v as W}from"./toast-7xJhDYMn-BrG8uCqw.mjs";let v;const G=()=>(v||(v=new S({concurrency:3})),v);var n=(e=>(e.MOVE="Move",e.COPY="Copy",e.MOVE_OR_COPY="move-or-copy",e))(n||{});const Y=e=>(e.reduce((i,a)=>Math.min(i,a.permissions),E.ALL)&E.UPDATE)!==0,H=e=>e.every(i=>{var a,l;return!JSON.parse((l=(a=i.attributes)==null?void 0:a["share-attributes"])!=null?l:"[]").some(s=>s.scope==="permissions"&&s.enabled===!1&&s.key==="download")}),_=e=>H(e),O=e=>Y(e)?_(e)?n.MOVE_OR_COPY:n.MOVE:n.COPY,g=async(e,i,a,l=!1)=>{if(i){if(i.type!==T.Folder)throw new Error(r("files","Destination is not a folder"));if(a===n.MOVE&&e.dirname===i.path)throw new Error(r("files","This file/folder is already in that directory"));if("".concat(i.path,"/").startsWith("".concat(e.path,"/")))throw new Error(r("files","You cannot move a file/folder onto itself or into a subfolder of itself"));return b.set(e,"status",j.LOADING),await G().add(async()=>{var s,o,d;const p=t=>t===1?r("files","(copy)"):r("files","(copy %n)",void 0,t);try{const t=k(),m=u.join(C,e.path),c=u.join(C,i.path);if(a===n.COPY){let y=e.basename;if(!l){const h=await t.getDirectoryContents(c);y=I(e.basename,h.map(f=>f.basename),p)}if(await t.copyFile(m,u.join(c,y)),e.dirname===i.path){const{data:h}=await t.stat(u.join(c,y),{details:!0,data:D()});M("files:node:created",N(h))}}else await t.moveFile(m,u.join(c,e.basename)),M("files:node:deleted",e)}catch(t){if(t instanceof x){if(((s=t==null?void 0:t.response)==null?void 0:s.status)===412)throw new Error(r("files","A file or folder with that name already exists in this folder"));if(((o=t==null?void 0:t.response)==null?void 0:o.status)===423)throw new Error(r("files","The files is locked"));if(((d=t==null?void 0:t.response)==null?void 0:d.status)===404)throw new Error(r("files","The file does not exist anymore"));if(t.message)throw new Error(t.message)}throw w.debug(t),new Error}finally{b.set(e,"status",void 0)}})}},P=async(e,i="/",a)=>{const l=a.map(o=>o.fileid).filter(Boolean),s=F(r("files","Choose destination")).allowDirectories(!0).setFilter(o=>(o.permissions&E.CREATE)!==0&&!l.includes(o.fileid)).setMimeTypeFilter([]).setMultiSelect(!1).startAt(i);return new Promise((o,d)=>{s.setButtonFactory((p,t)=>{const m=[],c=u.basename(t),y=a.map(f=>f.dirname),h=a.map(f=>f.path);return(e===n.COPY||e===n.MOVE_OR_COPY)&&m.push({label:c?r("files","Copy to {target}",{target:c}):r("files","Copy"),type:"primary",icon:L,async callback(f){o({destination:f[0],action:n.COPY})}}),y.includes(t)||h.includes(t)||(e===n.MOVE||e===n.MOVE_OR_COPY)&&m.push({label:c?r("files","Move to {target}",{target:c}):r("files","Move"),type:e===n.MOVE?"primary":"secondary",icon:V,async callback(f){o({destination:f[0],action:n.MOVE})}}),m}),s.build().pick().catch(p=>{w.debug(p),p instanceof R?d(new Error(r("files","Cancelled move or copy operation"))):d(new Error(r("files","Move or copy operation failed")))})})},ee=new A({id:"move-copy",displayName(e){switch(O(e)){case n.MOVE:return r("files","Move");case n.COPY:return r("files","Copy");case n.MOVE_OR_COPY:return r("files","Move or copy")}},iconSvgInline:()=>V,enabled(e){return e.every(i=>{var a;return(a=i.root)==null?void 0:a.startsWith("/files/")})?e.length>0&&(Y(e)||_(e)):!1},async exec(e,i,a){const l=O([e]);let s;try{s=await P(l,a,[e])}catch(o){return w.error(o),!1}try{return await g(e,s.destination,s.action),!0}catch(o){return o instanceof Error&&o.message?(W(o.message),null):!1}},async execBatch(e,i,a){const l=O(e),s=await P(l,a,e),o=e.map(async d=>{try{return await g(d,s.destination,s.action),!0}catch(p){return w.error("Failed to ".concat(s.action," node"),{node:d,error:p}),!1}});return await Promise.all(o)},order:15});function te(){B("nc:metadata-files-live-photo",{nc:"http://nextcloud.org/ns"})}function ae(e){return e.attributes["metadata-files-live-photo"]!==void 0}export{n as M,ee as a,ae as b,g as h,te as i};
