/*! third party licenses: dist/vendor.LICENSE.txt */
import{bD as k,bQ as _,bJ as g,bR as v,aM as C,V as P,a4 as T,bE as l,bK as E,bC as w}from"../core-common.mjs";import{p}from"./index-Ca0QcE7e.mjs";import{v as $}from"./toast-7xJhDYMn-BrG8uCqw.mjs";import{y as I}from"./index-BLIV22dB.mjs";import{e as S}from"./fileUtils-pqLuXd9u.mjs";import{n as b}from"./icons-BxSPavMS.mjs";import{l as m}from"./logger-CMIEMPjA.mjs";import"./index-DgCiVkaQ.mjs";import"./index-Biv1VH4I.mjs";const U=async function(){return(await k.get(_("apps/files/api/v1/templates"))).data.ocs.data},B=async function(e,t,i){return(await k.post(_("apps/files/api/v1/templates/create"),{filePath:e,templatePath:t,templateType:i})).data.ocs.data},N=function(){return!g()},M=function(){return document.getElementById("sharingToken")&&document.getElementById("sharingToken").value},s=256,W={name:"TemplatePreview",inheritAttrs:!1,props:{basename:{type:String,required:!0},checked:{type:Boolean,default:!1},fileid:{type:[String,Number],required:!0},filename:{type:String,required:!0},previewUrl:{type:String,default:null},hasPreview:{type:Boolean,default:!0},mime:{type:String,required:!0},ratio:{type:Number,default:null}},data(){return{failedPreview:!1}},computed:{nameWithoutExt(){return this.basename.indexOf(".")>-1?this.basename.split(".").slice(0,-1).join("."):this.basename},id(){return"template-picker-".concat(this.fileid)},realPreviewUrl(){return this.failedPreview&&this.mimeIcon?this.mimeIcon:this.previewUrl?this.previewUrl:N()?v("/apps/files_sharing/publicpreview/".concat(M(),"?fileId=").concat(this.fileid,"&file=").concat(S(this.filename),"&x=").concat(s,"&y=").concat(s,"&a=1")):v("/core/preview?fileId=".concat(this.fileid,"&x=").concat(s,"&y=").concat(s,"&a=1"))},mimeIcon(){return OC.MimeType.getIconUrl(this.mime)}},methods:{onCheck(){this.$emit("check",this.fileid)},onFailure(){this.failedPreview=!0}}};var q=function(){var e=this,t=e._self._c;return t("li",{staticClass:"template-picker__item"},[t("input",{staticClass:"radio",attrs:{id:e.id,type:"radio",name:"template-picker"},domProps:{checked:e.checked},on:{change:e.onCheck}}),t("label",{staticClass:"template-picker__label",attrs:{for:e.id}},[t("div",{staticClass:"template-picker__preview",class:e.failedPreview?"template-picker__preview--failed":""},[t("img",{staticClass:"template-picker__image",attrs:{src:e.realPreviewUrl,alt:"",draggable:"false"},on:{error:e.onFailure}})]),t("span",{staticClass:"template-picker__title"},[e._v(" "+e._s(e.nameWithoutExt)+" ")])])])},z=[],F=b(W,q,z,!1,null,"94fee79f",null,null);const D=F.exports,y=2,n=8,j=C({name:"TemplatePicker",components:{NcEmptyContent:P,NcModal:T,TemplatePreview:D},data(){return{checked:-1,loading:!1,name:null,opened:!1,provider:null}},computed:{extension(){var e;return p.extname((e=this.name)!=null?e:"")},nameWithoutExt(){return this.extension?this.name.slice(0,0-this.extension.length):this.name},emptyTemplate(){var e,t;return{basename:l("files","Blank"),fileid:-1,filename:l("files","Blank"),hasPreview:!1,mime:((e=this.provider)==null?void 0:e.mimetypes[0])||((t=this.provider)==null?void 0:t.mimetypes)}},selectedTemplate(){return this.provider?this.provider.templates.find(e=>e.fileid===this.checked):null},style(){if(!this.provider)return{};const e=(this.provider.ratio?this.provider.ratio:1.77)>1?n*30:n*20;return{"--margin":n+"px","--width":e+"px","--border":y+"px","--fullwidth":e+2*n+2*y+"px","--height":this.provider.ratio?Math.round(e/this.provider.ratio)+"px":null}}},methods:{t:l,async open(e,t){this.checked=this.emptyTemplate.fileid,this.name=e,this.provider=t;const i=(await U()).find(r=>r.app===t.app&&r.label===t.label);if(i===null)throw new Error("Failed to match provider in results");if(this.provider=i,i.templates.length===0){this.onSubmit();return}this.opened=!0},close(){this.checked=this.emptyTemplate.fileid,this.loading=!1,this.name=null,this.opened=!1,this.provider=null},onCheck(e){this.checked=e},async onSubmit(){var e,t,i,r,c,d,h,u;this.loading=!0;const x=new URL(window.location.href).searchParams.get("dir")||"/";this.nameWithoutExt===this.name&&(m.warn("Fixed invalid filename",{name:this.name,extension:(e=this.provider)==null?void 0:e.extension}),this.name="".concat(this.name).concat((i=(t=this.provider)==null?void 0:t.extension)!=null?i:""));try{const a=await B(p.normalize("".concat(x,"/").concat(this.name)),(c=(r=this.selectedTemplate)==null?void 0:r.filename)!=null?c:"",(h=(d=this.selectedTemplate)==null?void 0:d.templateType)!=null?h:"");m.debug("Created new file",a);const o=((u=g())==null?void 0:u.uid)||null,f=new I({id:a.fileid,source:E(p.join("dav/files/".concat(o),a.filename)),root:"/files/".concat(o),mime:a.mime,mtime:new Date(a.lastmod*1e3),owner:o,size:a.size,permissions:a.permissions,attributes:{...a,"has-preview":a.hasPreview}});w("files:node:created",f),w("files:node:focus",f),this.close()}catch(a){m.error("Error while creating the new file from template",{error:a}),$(l("files","Unable to create new file from template"))}finally{this.loading=!1}}}});var O=function(){var e=this,t=e._self._c;return e._self._setupProxy,e.opened?t("NcModal",{staticClass:"templates-picker",attrs:{"clear-view-delay":-1,size:"large"},on:{close:e.close}},[t("form",{staticClass:"templates-picker__form",style:e.style,on:{submit:function(i){return i.preventDefault(),i.stopPropagation(),e.onSubmit.apply(null,arguments)}}},[t("h2",[e._v(e._s(e.t("files","Pick a template for {name}",{name:e.nameWithoutExt})))]),t("ul",{staticClass:"templates-picker__list"},[t("TemplatePreview",e._b({attrs:{checked:e.checked===e.emptyTemplate.fileid},on:{check:e.onCheck}},"TemplatePreview",e.emptyTemplate,!1)),e._l(e.provider.templates,function(i){return t("TemplatePreview",e._b({key:i.fileid,attrs:{checked:e.checked===i.fileid,ratio:e.provider.ratio},on:{check:e.onCheck}},"TemplatePreview",i,!1))})],2),t("div",{staticClass:"templates-picker__buttons"},[t("input",{staticClass:"primary",attrs:{type:"submit","aria-label":e.t("files","Create a new file with the selected template")},domProps:{value:e.t("files","Create")}})])]),e.loading?t("NcEmptyContent",{staticClass:"templates-picker__loading",attrs:{icon:"icon-loading"}},[e._v(" "+e._s(e.t("files","Creating file"))+" ")]):e._e()],1):e._e()},R=[],A=b(j,O,R,!1,null,"ba197ef0",null,null);const Z=A.exports;export{Z as default};
