/*! third party licenses: dist/vendor.LICENSE.txt */
import{bK as x,bN as H,aG as R,bJ as v,bR as L,u as A,b as D,a0 as O,ao as B,bO as P,bE as c,bA as S,aM as N,F as T,aj as E,a2 as $,a4 as M,aw as U,c1 as q,c2 as K,bC as w,aH as m,bP as W}from"./core-common.mjs";import{a as j}from"./chunks/index-Ca0QcE7e.mjs";import{S as g,v as y}from"./chunks/toast-7xJhDYMn-BrG8uCqw.mjs";import{j as V}from"./chunks/index-DgCiVkaQ.mjs";import{m as p}from"./chunks/index-j_UZebeA.mjs";import{e as X}from"./chunks/fileUtils-pqLuXd9u.mjs";import{u as G}from"./chunks/index-Biv1VH4I.mjs";import{n as b,a0 as J,a1 as Y,a2 as Q,P as Z,m as ee,a3 as te,r as ie,a4 as se}from"./chunks/icons-BxSPavMS.mjs";import{p as ne}from"./chunks/v-tooltip.esm-CZvp28yr.mjs";import"./chunks/moment-B-oAqI-A.mjs";import"./chunks/moment-B1DRcIE-.mjs";import"./chunks/index-BLIV22dB.mjs";import"./chunks/_setToString-D2g9rVjk.mjs";import"./chunks/_Set-Cq4kerQ7.mjs";import"./chunks/_isIterateeCall-cIIcpi4J.mjs";import"./chunks/isPlainObject-wZJk5EJL.mjs";const oe="dav",re=x(oe);var k;const _=G(re,{headers:{"X-Requested-With":"XMLHttpRequest",requesttoken:(k=H())!=null?k:""}}),ae='<?xml version="1.0"?>\n<d:propfind xmlns:d="DAV:"\n	xmlns:oc="http://owncloud.org/ns"\n	xmlns:nc="http://nextcloud.org/ns"\n	xmlns:ocs="http://open-collaboration-services.org/ns">\n	<d:prop>\n		<d:getcontentlength />\n		<d:getcontenttype />\n		<d:getlastmodified />\n		<d:getetag />\n		<nc:version-label />\n		<nc:has-preview />\n	</d:prop>\n</d:propfind>',d=R.getLoggerBuilder().setApp("files_version").detectUser().build();async function le(e){var i;const s="/versions/".concat((i=v())==null?void 0:i.uid,"/versions/").concat(e.id);try{return(await _.getDirectoryContents(s,{data:ae,details:!0})).data.filter(({mime:n})=>n!=="").map(n=>de(n,e))}catch(n){throw d.error("Could not fetch version",{exception:n}),n}}async function ce(e){var i,s;try{d.debug("Restoring version",{url:e.url}),await _.moveFile("/versions/".concat((i=v())==null?void 0:i.uid,"/versions/").concat(e.fileId,"/").concat(e.fileVersion),"/versions/".concat((s=v())==null?void 0:s.uid,"/restore/target"))}catch(n){throw d.error("Could not restore version",{exception:n}),n}}function de(e,i){const s=p(e.lastmod).unix()*1e3;let n="";return s===i.mtime?n=L("/core/preview?fileId={fileId}&c={fileEtag}&x=250&y=250&forceIcon=0&a=0",{fileId:i.id,fileEtag:i.etag}):n=L("/apps/files_versions/preview?file={file}&version={fileVersion}",{file:V(i.path,i.name),fileVersion:e.basename}),{fileId:i.id,label:e.props["version-label"],filename:e.filename,basename:p(s).format("LLL"),mime:e.mime,etag:"".concat(e.props.getetag),size:e.size,type:e.type,mtime:s,permissions:"R",hasPreview:e.props["has-preview"]===1,previewUrl:n,url:V("/remote.php/dav",e.filename),source:x("dav")+X(e.filename),fileVersion:e.basename}}async function ue(e,i){return await _.customRequest(e.filename,{method:"PROPPATCH",data:'<?xml version="1.0"?>\n					<d:propertyupdate xmlns:d="DAV:"\n						xmlns:oc="http://owncloud.org/ns"\n						xmlns:nc="http://nextcloud.org/ns"\n						xmlns:ocs="http://open-collaboration-services.org/ns">\n					<d:set>\n						<d:prop>\n							<nc:version-label>'.concat(i,"</nc:version-label>\n						</d:prop>\n					</d:set>\n					</d:propertyupdate>")})}async function fe(e){await _.deleteFile(e.filename)}const he={name:"Version",components:{NcActionLink:A,NcActionButton:D,NcListItem:O,BackupRestore:J,Download:Y,FileCompare:Q,Pencil:Z,Delete:ee,ImageOffOutline:te},directives:{tooltip:B},filters:{humanReadableSize(e){return OC.Util.humanFileSize(e)},humanDateFromNow(e){return p(e).fromNow()}},props:{version:{type:Object,required:!0},fileInfo:{type:Object,required:!0},isCurrent:{type:Boolean,default:!1},isFirstVersion:{type:Boolean,default:!1},loadPreview:{type:Boolean,default:!1},canView:{type:Boolean,default:!1},canCompare:{type:Boolean,default:!1}},data(){return{previewLoaded:!1,previewErrored:!1,capabilities:P("core","capabilities",{files:{version_labeling:!1,version_deletion:!1}})}},computed:{versionLabel(){var i;const e=(i=this.version.label)!=null?i:"";return this.isCurrent?e===""?c("files_versions","Current version"):"".concat(e," (").concat(c("files_versions","Current version"),")"):this.isFirstVersion&&e===""?c("files_versions","Initial version"):e},downloadURL(){return this.isCurrent?S()+V("/remote.php/webdav",this.fileInfo.path,this.fileInfo.name):S()+this.version.url},formattedDate(){return p(this.version.mtime).format("LLL")},enableLabeling(){return this.capabilities.files.version_labeling===!0},enableDeletion(){return this.capabilities.files.version_deletion===!0}},methods:{labelUpdate(){this.$emit("label-update-request")},restoreVersion(){this.$emit("restore",this.version)},deleteVersion(){this.$emit("delete",this.version)},click(){if(!this.canView){window.location=this.downloadURL;return}this.$emit("click",{version:this.version})},compareVersion(){if(!this.canView)throw new Error("Cannot compare version of this file");this.$emit("compare",{version:this.version})},t:c}};var me=function(){var e=this,i=e._self._c;return i("NcListItem",{staticClass:"version",attrs:{name:e.versionLabel,"force-display-actions":!0,"data-files-versions-version":""},on:{click:e.click},scopedSlots:e._u([{key:"icon",fn:function(){return[e.loadPreview||e.previewLoaded?(e.isCurrent||e.version.hasPreview)&&!e.previewErrored?i("img",{staticClass:"version__image",attrs:{src:e.version.previewUrl,alt:"",decoding:"async",fetchpriority:"low",loading:"lazy"},on:{load:function(s){e.previewLoaded=!0},error:function(s){e.previewErrored=!0}}}):i("div",{staticClass:"version__image"},[i("ImageOffOutline",{attrs:{size:20}})],1):i("div",{staticClass:"version__image"})]},proxy:!0},{key:"subname",fn:function(){return[i("div",{staticClass:"version__info"},[i("span",{attrs:{title:e.formattedDate}},[e._v(e._s(e._f("humanDateFromNow")(e.version.mtime)))]),i("span",{staticClass:"version__info__size"},[e._v("â€¢")]),i("span",{staticClass:"version__info__size"},[e._v(e._s(e._f("humanReadableSize")(e.version.size)))])])]},proxy:!0},{key:"actions",fn:function(){return[e.enableLabeling?i("NcActionButton",{attrs:{"close-after-click":!0},on:{click:e.labelUpdate},scopedSlots:e._u([{key:"icon",fn:function(){return[i("Pencil",{attrs:{size:22}})]},proxy:!0}],null,!1,3072546167)},[e._v(" "+e._s(e.version.label===""?e.t("files_versions","Name this version"):e.t("files_versions","Edit version name"))+" ")]):e._e(),!e.isCurrent&&e.canView&&e.canCompare?i("NcActionButton",{attrs:{"close-after-click":!0},on:{click:e.compareVersion},scopedSlots:e._u([{key:"icon",fn:function(){return[i("FileCompare",{attrs:{size:22}})]},proxy:!0}],null,!1,1958207595)},[e._v(" "+e._s(e.t("files_versions","Compare to current version"))+" ")]):e._e(),e.isCurrent?e._e():i("NcActionButton",{attrs:{"close-after-click":!0},on:{click:e.restoreVersion},scopedSlots:e._u([{key:"icon",fn:function(){return[i("BackupRestore",{attrs:{size:22}})]},proxy:!0}],null,!1,2239038444)},[e._v(" "+e._s(e.t("files_versions","Restore version"))+" ")]),i("NcActionLink",{attrs:{href:e.downloadURL,"close-after-click":!0,download:e.downloadURL},scopedSlots:e._u([{key:"icon",fn:function(){return[i("Download",{attrs:{size:22}})]},proxy:!0}])},[e._v(" "+e._s(e.t("files_versions","Download version"))+" ")]),!e.isCurrent&&e.enableDeletion?i("NcActionButton",{attrs:{"close-after-click":!0},on:{click:e.deleteVersion},scopedSlots:e._u([{key:"icon",fn:function(){return[i("Delete",{attrs:{size:22}})]},proxy:!0}],null,!1,2429175571)},[e._v(" "+e._s(e.t("files_versions","Delete version"))+" ")]):e._e()]},proxy:!0}])})},ve=[],pe=b(he,me,ve,!1,null,"b40bfb7f",null,null);const be=pe.exports,_e=N({name:"VirtualScrolling",props:{sections:{type:Array,required:!0},containerElement:{type:HTMLElement,default:null},useWindow:{type:Boolean,default:!1},headerHeight:{type:Number,default:75},renderDistance:{type:Number,default:.5},bottomBufferRatio:{type:Number,default:2},scrollToKey:{type:String,default:""}},data(){return{scrollPosition:0,containerHeight:0,rowsContainerHeight:0,resizeObserver:null}},computed:{visibleSections(){d.debug("[VirtualScrolling] Computing visible section",{sections:this.sections});const e=this.containerHeight,i=this.scrollPosition,s=i+e;let n=0,a=0;const C=this.sections.map(o=>(a+=this.headerHeight,{...o,rows:o.rows.reduce((l,f)=>{n=a,a+=f.height;let h=0;return a<i?h=(i-a)/e:n>s&&(h=(n-s)/e),h>this.renderDistance?l:[...l,{...f,distance:h}]},[])})).filter(o=>o.rows.length>0),u=C.flatMap(({rows:o})=>o).flatMap(({items:o})=>o),I=this._rowIdToKeyMap;u.forEach(o=>o.key=I[o.id]);const F=u.map(({key:o})=>o).filter(o=>o!==void 0),z=Object.values(I).filter(o=>!F.includes(o));return u.filter(({key:o})=>o===void 0).forEach(o=>{var l;return o.key=(l=z.pop())!=null?l:Math.random().toString(36).substr(2)}),this._rowIdToKeyMap=u.reduce((o,{id:l,key:f})=>({...o,["".concat(l)]:f}),{}),C},totalHeight(){return this.sections.map(e=>this.headerHeight+e.height).reduce((e,i)=>e+i,0)+0},paddingTop(){if(this.visibleSections.length===0)return 0;let e=0;for(const i of this.sections){if(i.key!==this.visibleSections[0].rows[0].sectionKey){e+=this.headerHeight+i.height;continue}for(const s of i.rows){if(s.key===this.visibleSections[0].rows[0].key)return e;e+=s.height}e+=this.headerHeight}return e},rowsContainerStyle(){return{height:"".concat(this.totalHeight,"px"),paddingTop:"".concat(this.paddingTop,"px")}},isNearBottom(){const e=this.containerHeight*this.bottomBufferRatio;return this.scrollPosition+this.containerHeight>=this.totalHeight-e},container(){return d.debug("[VirtualScrolling] Computing container"),this.containerElement!==null?this.containerElement:this.useWindow?window:this.$refs.container}},watch:{isNearBottom(e){d.debug("[VirtualScrolling] isNearBottom changed",{value:e}),e&&this.$emit("need-content")},visibleSections(){this.isNearBottom&&this.$emit("need-content")},scrollToKey(e){let i=0;for(const s of this.sections){if(s.key!==e){i+=this.headerHeight+s.height;continue}break}d.debug("[VirtualScrolling] Scrolling to",{currentRowTopDistanceFromTop:i}),this.container.scrollTo({top:i,behavior:"smooth"})}},beforeCreate(){this._rowIdToKeyMap={}},mounted(){this.resizeObserver=new ResizeObserver(e=>{for(const i of e){const s=i.contentRect;i.target===this.container&&(this.containerHeight=s.height),i.target.classList.contains("vs-rows-container")&&(this.rowsContainerHeight=s.height)}}),this.useWindow?(window.addEventListener("resize",this.updateContainerSize,{passive:!0}),this.containerHeight=window.innerHeight):this.resizeObserver.observe(this.container),this.resizeObserver.observe(this.$refs.rowsContainer),this.container.addEventListener("scroll",this.updateScrollPosition,{passive:!0})},beforeDestroy(){var e;this.useWindow&&window.removeEventListener("resize",this.updateContainerSize),(e=this.resizeObserver)==null||e.disconnect(),this.container.removeEventListener("scroll",this.updateScrollPosition)},methods:{updateScrollPosition(){var e;(e=this._onScrollHandle)!=null||(this._onScrollHandle=requestAnimationFrame(()=>{this._onScrollHandle=null,this.useWindow?this.scrollPosition=this.container.scrollY:this.scrollPosition=this.container.scrollTop}))},updateContainerSize(){this.containerHeight=window.innerHeight}}});var we=function(){var e=this,i=e._self._c;return e._self._setupProxy,!e.useWindow&&e.containerElement===null?i("div",{ref:"container",staticClass:"vs-container"},[i("div",{ref:"rowsContainer",staticClass:"vs-rows-container",style:e.rowsContainerStyle},[e._t("default",null,{visibleSections:e.visibleSections}),e._t("loader")],2)]):i("div",{ref:"rowsContainer",staticClass:"vs-rows-container",style:e.rowsContainerStyle},[e._t("default",null,{visibleSections:e.visibleSections}),e._t("loader")],2)},ge=[],ye=b(_e,we,ge,!1,null,"5fe6761e",null,null);const Ve=ye.exports,Ce=N({name:"VersionLabelForm",components:{NcButton:T,NcTextField:E,Check:ie},props:{versionLabel:{type:String,default:""}},data(){return{innerVersionLabel:this.versionLabel}},mounted(){this.$nextTick(()=>{this.$refs.labelInput.$el.getElementsByTagName("input")[0].focus()})},methods:{setVersionLabel(e){this.$emit("label-update",e)},t:c}});var Ie=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("form",{staticClass:"version-label-modal",on:{submit:function(s){return s.preventDefault(),e.setVersionLabel(e.innerVersionLabel)}}},[i("label",[i("div",{staticClass:"version-label-modal__title"},[e._v(e._s(e.t("files_versions","Version name")))]),i("NcTextField",{ref:"labelInput",attrs:{value:e.innerVersionLabel,placeholder:e.t("files_versions","Version name"),"label-outside":!0},on:{"update:value":function(s){e.innerVersionLabel=s}}})],1),i("div",{staticClass:"version-label-modal__info"},[e._v(" "+e._s(e.t("files_versions","Named versions are persisted, and excluded from automatic cleanups when your storage quota is full."))+" ")]),i("div",{staticClass:"version-label-modal__actions"},[i("NcButton",{attrs:{disabled:e.innerVersionLabel.trim().length===0},on:{click:function(s){return e.setVersionLabel("")}}},[e._v(" "+e._s(e.t("files_versions","Remove version name"))+" ")]),i("NcButton",{attrs:{type:"primary","native-type":"submit"},scopedSlots:e._u([{key:"icon",fn:function(){return[i("Check")]},proxy:!0}])},[e._v(" "+e._s(e.t("files_versions","Save version name"))+" ")])],1)])},Le=[],Se=b(Ce,Ie,Le,!1,null,"2e26ac08",null,null);const ke=Se.exports,xe={name:"VersionTab",components:{Version:be,VirtualScrolling:Ve,VersionLabelForm:ke,NcLoadingIcon:$,NcModal:M},mixins:[U],data(){return{fileInfo:null,isActive:!1,versions:[],loading:!1,showVersionLabelForm:!1}},computed:{sections(){return[{key:"versions",rows:this.orderedVersions.map(e=>({key:e.mtime,height:68,sectionKey:"versions",items:[e]})),height:68*this.orderedVersions.length}]},orderedVersions(){return[...this.versions].sort((e,i)=>e.mtime===this.fileInfo.mtime?-1:i.mtime===this.fileInfo.mtime?1:i.mtime-e.mtime)},initialVersionMtime(){return this.versions.map(e=>e.mtime).reduce((e,i)=>Math.min(e,i))},viewerFileInfo(){let e="";return this.fileInfo.permissions&1&&(e+="R"),this.fileInfo.permissions&2&&(e+="W"),this.fileInfo.permissions&8&&(e+="D"),{...this.fileInfo,mime:this.fileInfo.mimetype,basename:this.fileInfo.name,filename:this.fileInfo.path+"/"+this.fileInfo.name,permissions:e,fileid:this.fileInfo.id}},canView(){var e,i;return(i=(e=window.OCA.Viewer)==null?void 0:e.mimetypesCompare)==null?void 0:i.includes(this.fileInfo.mimetype)},canCompare(){return!this.isMobile}},mounted(){q("files_versions:restore:restored",this.fetchVersions)},beforeUnmount(){K("files_versions:restore:restored",this.fetchVersions)},methods:{async update(e){this.fileInfo=e,this.resetState(),this.fetchVersions()},async setIsActive(e){this.isActive=e},async fetchVersions(){try{this.loading=!0,this.versions=await le(this.fileInfo)}finally{this.loading=!1}},async handleRestore(e){const i=this.fileInfo;this.fileInfo={...this.fileInfo,size:e.size,mtime:e.mtime};const s={preventDefault:!1,fileInfo:this.fileInfo,version:e};if(w("files_versions:restore:requested",s),!s.preventDefault)try{await ce(e),e.label!==""?g(t("files_versions","".concat(e.label," restored"))):e.mtime===this.initialVersionMtime?g(t("files_versions","Initial version restored")):g(t("files_versions","Version restored")),w("files_versions:restore:restored",e)}catch{this.fileInfo=i,y(t("files_versions","Could not restore version")),w("files_versions:restore:failed",e)}},handleLabelUpdateRequest(e){this.showVersionLabelForm=!0,this.editedVersion=e},async handleLabelUpdate(e){const i=this.editedVersion.label;this.editedVersion.label=e,this.showVersionLabelForm=!1;try{await ue(this.editedVersion,e),this.editedVersion=null}catch(s){this.editedVersion.label=i,y(this.t("files_versions","Could not set version label")),logger.error("Could not set version label",{exception:s})}},async handleDelete(e){const i=this.versions.indexOf(e);this.versions.splice(i,1);try{await fe(e)}catch{this.versions.push(e),y(t("files_versions","Could not delete version"))}},resetState(){this.$set(this,"versions",[])},openVersion({version:e}){if(e.mtime===this.fileInfo.mtime){OCA.Viewer.open({fileInfo:this.viewerFileInfo});return}const i=this.versions.map(s=>{var n,a;return{...s,filename:s.mtime===this.fileInfo.mtime?j.join("files",(a=(n=v())==null?void 0:n.uid)!=null?a:"",this.fileInfo.path,this.fileInfo.name):s.filename,hasPreview:!1,previewUrl:void 0}});OCA.Viewer.open({fileInfo:i.find(s=>s.source===e.source),enableSidebar:!1})},compareVersion({version:e}){const i=this.versions.map(s=>({...s,hasPreview:!1,previewUrl:void 0}));OCA.Viewer.compare(this.viewerFileInfo,i.find(s=>s.source===e.source))}}};var Ne=function(){var e=this,i=e._self._c;return i("div",{staticClass:"versions-tab__container"},[i("VirtualScrolling",{attrs:{sections:e.sections,"header-height":0},scopedSlots:e._u([{key:"default",fn:function({visibleSections:s}){return[i("ul",{attrs:{"data-files-versions-versions-list":""}},[s.length===1?e._l(s[0].rows,function(n){return i("Version",{key:n.items[0].mtime,attrs:{"can-view":e.canView,"can-compare":e.canCompare,"load-preview":e.isActive,version:n.items[0],"file-info":e.fileInfo,"is-current":n.items[0].mtime===e.fileInfo.mtime,"is-first-version":n.items[0].mtime===e.initialVersionMtime},on:{click:e.openVersion,compare:e.compareVersion,restore:e.handleRestore,"label-update-request":function(a){return e.handleLabelUpdateRequest(n.items[0])},delete:e.handleDelete}})}):e._e()],2)]}}])},[e.loading?i("NcLoadingIcon",{staticClass:"files-list-viewer__loader",attrs:{slot:"loader"},slot:"loader"}):e._e()],1),e.showVersionLabelForm?i("NcModal",{attrs:{title:e.t("files_versions","Name this version")},on:{close:function(s){e.showVersionLabelForm=!1}}},[i("VersionLabelForm",{attrs:{"version-label":e.editedVersion.label},on:{"label-update":e.handleLabelUpdate}})],1):e._e()],1)},Fe=[],ze=b(xe,Ne,Fe,!1,null,null,null,null);const He=ze.exports;m.prototype.t=c,m.prototype.n=W,m.use(ne);const Re=m.extend(He);let r=null;window.addEventListener("DOMContentLoaded",function(){var e;((e=OCA.Files)==null?void 0:e.Sidebar)!==void 0&&OCA.Files.Sidebar.registerTab(new OCA.Files.Sidebar.Tab({id:"version_vue",name:c("files_versions","Versions"),iconSvg:se,async mount(i,s,n){r&&r.$destroy(),r=new Re({parent:n}),await r.update(s),r.$mount(i)},update(i){r.update(i)},setIsActive(i){r&&r.setIsActive(i)},destroy(){r.$destroy(),r=null},enabled(i){var s;return!((s=i==null?void 0:i.isDirectory())==null||s)}}))});
