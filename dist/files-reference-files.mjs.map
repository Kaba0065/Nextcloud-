{"version":3,"file":"files-reference-files.mjs","sources":["../apps/files/src/views/ReferenceFileWidget.vue","../apps/files/src/views/FileReferencePickerElement.vue","../apps/files/src/reference-files.js"],"sourcesContent":["<!--\n  - @copyright Copyright (c) 2022 Julius Härtl <jus@bitgrid.net>\n  -\n  - @author Julius Härtl <jus@bitgrid.net>\n  -\n  - @license GNU AGPL version 3 or any later version\n  -\n  - This program is free software: you can redistribute it and/or modify\n  - it under the terms of the GNU Affero General Public License as\n  - published by the Free Software Foundation, either version 3 of the\n  - License, or (at your option) any later version.\n  -\n  - This program is distributed in the hope that it will be useful,\n  - but WITHOUT ANY WARRANTY; without even the implied warranty of\n  - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n  - GNU Affero General Public License for more details.\n  -\n  - You should have received a copy of the GNU Affero General Public License\n  - along with this program. If not, see <http://www.gnu.org/licenses/>.\n  -->\n\n<template>\n\t<div v-if=\"!accessible\" class=\"widget-file widget-file--no-access\">\n\t\t<div class=\"widget-file--image widget-file--image--icon icon-folder\" />\n\t\t<div class=\"widget-file--details\">\n\t\t\t<p class=\"widget-file--title\">\n\t\t\t\t{{ t('files', 'File cannot be accessed') }}\n\t\t\t</p>\n\t\t\t<p class=\"widget-file--description\">\n\t\t\t\t{{ t('files', 'The file could not be found or you do not have permissions to view it. Ask the sender to share it.') }}\n\t\t\t</p>\n\t\t</div>\n\t</div>\n\t<a v-else\n\t\tclass=\"widget-file\"\n\t\t:href=\"richObject.link\"\n\t\t@click.prevent=\"navigate\">\n\t\t<div class=\"widget-file--image\" :class=\"filePreviewClass\" :style=\"filePreview\" />\n\t\t<div class=\"widget-file--details\">\n\t\t\t<p class=\"widget-file--title\">{{ richObject.name }}</p>\n\t\t\t<p class=\"widget-file--description\">{{ fileSize }}<br>{{ fileMtime }}</p>\n\t\t\t<p class=\"widget-file--link\">{{ filePath }}</p>\n\t\t</div>\n\t</a>\n</template>\n<script>\nimport { generateUrl } from '@nextcloud/router'\nimport path from 'path'\n\nexport default {\n\tname: 'ReferenceFileWidget',\n\tprops: {\n\t\trichObject: {\n\t\t\ttype: Object,\n\t\t\trequired: true,\n\t\t},\n\t\taccessible: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: true,\n\t\t},\n\t},\n\tdata() {\n\t\treturn {\n\t\t\tpreviewUrl: window.OC.MimeType.getIconUrl(this.richObject.mimetype),\n\t\t}\n\t},\n\tcomputed: {\n\t\tfileSize() {\n\t\t\treturn window.OC.Util.humanFileSize(this.richObject.size)\n\t\t},\n\t\tfileMtime() {\n\t\t\treturn window.OC.Util.relativeModifiedDate(this.richObject.mtime * 1000)\n\t\t},\n\t\tfilePath() {\n\t\t\treturn path.dirname(this.richObject.path)\n\t\t},\n\t\tfilePreview() {\n\t\t\tif (this.previewUrl) {\n\t\t\t\treturn {\n\t\t\t\t\tbackgroundImage: 'url(' + this.previewUrl + ')',\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tbackgroundImage: 'url(' + window.OC.MimeType.getIconUrl(this.richObject.mimetype) + ')',\n\t\t\t}\n\n\t\t},\n\t\tfilePreviewClass() {\n\t\t\tif (this.previewUrl) {\n\t\t\t\treturn 'widget-file--image--preview'\n\t\t\t}\n\t\t\treturn 'widget-file--image--icon'\n\n\t\t},\n\t},\n\tmounted() {\n\t\tif (this.richObject['preview-available']) {\n\t\t\tconst previewUrl = generateUrl('/core/preview?fileId={fileId}&x=250&y=250', {\n\t\t\t\tfileId: this.richObject.id,\n\t\t\t})\n\t\t\tconst img = new Image()\n\t\t\timg.onload = () => {\n\t\t\t\tthis.previewUrl = previewUrl\n\t\t\t}\n\t\t\timg.onerror = err => {\n\t\t\t\tconsole.error('could not load recommendation preview', err)\n\t\t\t}\n\t\t\timg.src = previewUrl\n\t\t}\n\t},\n\tmethods: {\n\t\tnavigate() {\n\t\t\tif (OCA.Viewer && OCA.Viewer.mimetypes.indexOf(this.richObject.mimetype) !== -1) {\n\t\t\t\tOCA.Viewer.open({ path: this.richObject.path })\n\t\t\t\treturn\n\t\t\t}\n\t\t\twindow.location = this.richObject.link\n\t\t},\n\t},\n}\n</script>\n<style lang=\"scss\" scoped>\n.widget-file {\n\tdisplay: flex;\n\tflex-grow: 1;\n\tcolor: var(--color-main-text) !important;\n\ttext-decoration: none !important;\n\n\t&--image {\n\t\tmin-width: 40%;\n\t\tbackground-position: center;\n\t\tbackground-size: cover;\n\t\tbackground-repeat: no-repeat;\n\n\t\t&.widget-file--image--icon {\n\t\t\tmin-width: 88px;\n\t\t\tbackground-size: 44px;\n\t\t}\n\t}\n\n\t&--title {\n\t\toverflow: hidden;\n\t\ttext-overflow: ellipsis;\n\t\twhite-space: nowrap;\n\t\tfont-weight: bold;\n\t}\n\n\t&--details {\n\t\tpadding: 12px;\n\t\tflex-grow: 1;\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\n\t\tp {\n\t\t\tmargin: 0;\n\t\t\tpadding: 0;\n\t\t}\n\t}\n\n\t&--description {\n\t\toverflow: hidden;\n\t\ttext-overflow: ellipsis;\n\t\tdisplay: -webkit-box;\n\t\t-webkit-line-clamp: 3;\n\t\tline-clamp: 3;\n\t\t-webkit-box-orient: vertical;\n\t}\n\n\t&--link {\n\t\tcolor: var(--color-text-maxcontrast);\n\t}\n\n\t&.widget-file--no-access {\n\t\tpadding: 12px;\n\n\t\t.widget-file--details {\n\t\t\tpadding: 0;\n\t\t}\n\t}\n}\n</style>\n","<!--\n  - @copyright Copyright (c) 2023 Julius Härtl <jus@bitgrid.net>\n  -\n  - @author Julius Härtl <jus@bitgrid.net>\n  -\n  - @license GNU AGPL version 3 or any later version\n  -\n  - This program is free software: you can redistribute it and/or modify\n  - it under the terms of the GNU Affero General Public License as\n  - published by the Free Software Foundation, either version 3 of the\n  - License, or (at your option) any later version.\n  -\n  - This program is distributed in the hope that it will be useful,\n  - but WITHOUT ANY WARRANTY; without even the implied warranty of\n  - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n  - GNU Affero General Public License for more details.\n  -\n  - You should have received a copy of the GNU Affero General Public License\n  - along with this program. If not, see <http://www.gnu.org/licenses/>.\n  -->\n\n<template>\n\t<div :id=\"containerId\">\n\t\t<FilePicker v-bind=\"filepickerOptions\" @close=\"onClose\" />\n\t</div>\n</template>\n\n<script lang=\"ts\">\nimport type { Node as NcNode } from '@nextcloud/files'\nimport type { IFilePickerButton } from '@nextcloud/dialogs'\n\nimport { FilePickerVue as FilePicker } from '@nextcloud/dialogs/filepicker.js'\nimport { translate as t } from '@nextcloud/l10n'\nimport { generateUrl } from '@nextcloud/router'\nimport { defineComponent } from 'vue'\n\nexport default defineComponent({\n\tname: 'FileReferencePickerElement',\n\tcomponents: {\n\t\tFilePicker,\n\t},\n\tprops: {\n\t\tproviderId: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t\taccessible: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: false,\n\t\t},\n\t},\n\tcomputed: {\n\t\tcontainerId() {\n\t\t\treturn `filepicker-${Math.random().toString(36).slice(7)}`\n\t\t},\n\t\tfilepickerOptions() {\n\t\t\treturn {\n\t\t\t\tallowPickDirectory: false,\n\t\t\t\tbuttons: this.buttonFactory,\n\t\t\t\tcontainer: `#${this.containerId}`,\n\t\t\t\tmultiselect: false,\n\t\t\t\tname: t('files', 'Select file or folder to link to'),\n\t\t\t}\n\t\t},\n\t},\n\tmethods: {\n\t\tt,\n\n\t\tbuttonFactory(selected: NcNode[]): IFilePickerButton[] {\n\t\t\tconst buttons = [] as IFilePickerButton[]\n\t\t\tif (selected.length === 0) {\n\t\t\t\tbuttons.push({\n\t\t\t\t\tlabel: t('files', 'Choose file'),\n\t\t\t\t\ttype: 'tertiary' as never,\n\t\t\t\t\tcallback: this.onClose,\n\t\t\t\t})\n\t\t\t} else {\n\t\t\t\tbuttons.push({\n\t\t\t\t\tlabel: t('files', 'Choose {file}', { file: selected[0].basename }),\n\t\t\t\t\ttype: 'primary',\n\t\t\t\t\tcallback: this.onClose,\n\t\t\t\t})\n\t\t\t}\n\t\t\treturn buttons\n\t\t},\n\n\t\tonClose(nodes?: NcNode[]) {\n\t\t\tif (nodes === undefined || nodes.length === 0) {\n\t\t\t\tthis.$emit('cancel')\n\t\t\t} else {\n\t\t\t\tthis.onSubmit(nodes[0])\n\t\t\t}\n\t\t},\n\n\t\tonSubmit(node: NcNode) {\n\t\t\tconst url = new URL(window.location.href)\n\t\t\turl.pathname = generateUrl('/f/{fileId}', { fileId: node.fileid! })\n\t\t\turl.search = ''\n\t\t\tthis.$emit('submit', url.href)\n\t\t},\n\t},\n})\n</script>\n","/**\n * @copyright Copyright (c) 2022 Julius Härtl <jus@bitgrid.net>\n *\n * @author Julius Härtl <jus@bitgrid.net>\n *\n * @license GNU AGPL version 3 or any later version\n *\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport Vue from 'vue'\nimport { translate as t } from '@nextcloud/l10n'\n\nimport { registerWidget, registerCustomPickerElement, NcCustomPickerRenderResult } from '@nextcloud/vue/dist/Components/NcRichText.js'\n\nimport FileWidget from './views/ReferenceFileWidget.vue'\nimport FileReferencePickerElement from './views/FileReferencePickerElement.vue'\n\nVue.mixin({\n\tmethods: {\n\t\tt,\n\t},\n})\n\nregisterWidget('file', (el, { richObjectType, richObject, accessible }) => {\n\tconst Widget = Vue.extend(FileWidget)\n\tnew Widget({\n\t\tpropsData: {\n\t\t\trichObjectType,\n\t\t\trichObject,\n\t\t\taccessible,\n\t\t},\n\t}).$mount(el)\n})\n\nregisterCustomPickerElement('files', (el, { providerId, accessible }) => {\n\tconst Element = Vue.extend(FileReferencePickerElement)\n\tconst vueElement = new Element({\n\t\tpropsData: {\n\t\t\tproviderId,\n\t\t\taccessible,\n\t\t},\n\t}).$mount(el)\n\treturn new NcCustomPickerRenderResult(vueElement.$el, vueElement)\n}, (el, renderResult) => {\n\trenderResult.object.$destroy()\n})\n"],"names":["_sfc_main","path","previewUrl","generateUrl","img","err","defineComponent","FilePicker","t","selected","buttons","nodes","node","url","Vue","registerWidget","el","richObjectType","richObject","accessible","Widget","FileWidget","registerCustomPickerElement","providerId","Element","FileReferencePickerElement","vueElement","NcCustomPickerRenderResult","renderResult"],"mappings":"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"}