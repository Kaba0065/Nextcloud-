/*! third party licenses: dist/vendor.LICENSE.txt */
import{bG as E,ad as q,F as A,G as R,ag as W,bO as g,bD as x,bQ as F,bR as U,aG as j,aH as m}from"./core-common.mjs";import{e as z,b as Q,c as B,d as V,f as Y,g as J,a as K}from"./chunks/_Set-Cq4kerQ7.mjs";import{n as X,_ as Z,t as ee}from"./chunks/toNumber-B8U-PqxL.mjs";import{n as I}from"./chunks/icons-BxSPavMS.mjs";import{H as te}from"./chunks/style-3JoZM1Ml.mjs";import"./chunks/index-Ca0QcE7e.mjs";import{v as ne}from"./chunks/toast-7xJhDYMn-BrG8uCqw.mjs";import{V as oe,S as se}from"./chunks/vuex.esm-Bkiv_nyi.mjs";import"./chunks/isSymbol-D7eKlFoH.mjs";var re=z;function ie(e,n){for(var o=-1,r=e.length,c=0,l=[];++o<r;){var i=e[o],s=n?n(i):i;if(!o||!re(s,d)){var d=s;l[c++]=i===0?0:i}}return l}var ae=ie,ce=ae;function de(e){return e&&e.length?ce(e):[]}var le=de;const D=E(le);function ue(e,n,o){for(var r=-1,c=e==null?0:e.length;++r<c;)if(o(n,e[r]))return!0;return!1}var pe=ue,G=Q,he=X,fe=B,ge=1/0,me=G&&1/fe(new G([,-0]))[1]==ge?function(e){return new G(e)}:he,ye=me,ve=V,be=Z,we=pe,_e=Y,Ge=ye,ke=B,xe=200;function Ee(e,n,o){var r=-1,c=be,l=e.length,i=!0,s=[],d=s;if(o)i=!1,c=we;else if(l>=xe){var h=n?null:Ge(e);if(h)return ke(h);i=!1,c=_e,d=new ve}else d=n?[]:s;e:for(;++r<l;){var p=e[r],u=n?n(p):p;if(p=o||p!==0?p:0,i&&u===u){for(var y=d.length;y--;)if(d[y]===u)continue e;n&&d.push(u),s.push(p)}else c(d,u,o)||(d!==s&&d.push(u),s.push(p))}return s}var Se=Ee,Ce=Se;function Ne(e){return e&&e.length?Ce(e):[]}var De=Ne;const M=E(De);var Me=J,Te=function(){return Me.Date.now()},Ae=Te,Re=K,k=Ae,T=ee,We="Expected a function",Fe=Math.max,Be=Math.min;function Ie(e,n,o){var r,c,l,i,s,d,h=0,p=!1,u=!1,y=!0;if(typeof e!="function")throw new TypeError(We);n=T(n)||0,Re(o)&&(p=!!o.leading,u="maxWait"in o,l=u?Fe(T(o.maxWait)||0,n):l,y="trailing"in o?!!o.trailing:y);function w(a){var f=r,v=c;return r=c=void 0,h=a,i=e.apply(v,f),i}function O(a){return h=a,s=setTimeout(b,n),p?w(a):i}function P(a){var f=a-d,v=a-h,N=n-f;return u?Be(N,l-v):N}function S(a){var f=a-d,v=a-h;return d===void 0||f>=n||f<0||u&&v>=l}function b(){var a=k();if(S(a))return C(a);s=setTimeout(b,P(a))}function C(a){return s=void 0,y&&r?w(a):(r=c=void 0,i)}function H(){s!==void 0&&clearTimeout(s),h=0,r=d=c=s=void 0}function L(){return s===void 0?i:C(k())}function _(){var a=k(),f=S(a);if(r=arguments,c=this,d=a,f){if(s===void 0)return O(d);if(u)return clearTimeout(s),s=setTimeout(b,n),w(d)}return s===void 0&&(s=setTimeout(b,n)),i}return _.cancel=H,_.flush=L,_}var $e=Ie;const Oe=E($e),Pe={name:"AdminTwoFactor",components:{NcSelect:q,NcButton:A,NcCheckboxRadioSwitch:R,NcSettingsSection:W},data(){return{loading:!1,dirty:!1,groups:[],loadingGroups:!1,twoFactorAdminDoc:g("settings","two-factor-admin-doc")}},computed:{enforced:{get(){return this.$store.state.enforced},set(e){this.dirty=!0,this.$store.commit("setEnforced",e)}},enforcedGroups:{get(){return this.$store.state.enforcedGroups},set(e){this.dirty=!0,this.$store.commit("setEnforcedGroups",e)}},excludedGroups:{get(){return this.$store.state.excludedGroups},set(e){this.dirty=!0,this.$store.commit("setExcludedGroups",e)}}},mounted(){this.groups=D(M(this.enforcedGroups.concat(this.excludedGroups))),this.searchGroup("")},methods:{searchGroup:Oe(function(e){this.loadingGroups=!0,x.get(F("cloud/groups?offset=0&search={query}&limit=20",{query:e})).then(n=>n.data.ocs).then(n=>n.data.groups).then(n=>{this.groups=D(M(this.groups.concat(n)))}).catch(n=>console.error("could not search groups",n)).then(()=>{this.loadingGroups=!1})},500),saveChanges(){this.loading=!0;const e={enforced:this.enforced,enforcedGroups:this.enforcedGroups,excludedGroups:this.excludedGroups};x.put(U("/settings/api/admin/twofactorauth"),e).then(n=>n.data).then(n=>{this.state=n,this.dirty=!1}).catch(n=>{console.error("could not save changes",n)}).then(()=>{this.loading=!1})}}};var He=function(){var e=this,n=e._self._c;return n("NcSettingsSection",{attrs:{name:e.t("settings","Two-Factor Authentication"),description:e.t("settings","Two-factor authentication can be enforced for all users and specific groups. If they do not have a two-factor provider configured, they will be unable to log into the system."),"doc-url":e.twoFactorAdminDoc}},[e.loading?n("p",[n("span",{staticClass:"icon-loading-small two-factor-loading"}),n("span",[e._v(e._s(e.t("settings","Enforce two-factor authentication")))])]):n("NcCheckboxRadioSwitch",{attrs:{id:"two-factor-enforced",checked:e.enforced,type:"switch"},on:{"update:checked":function(o){e.enforced=o}}},[e._v(" "+e._s(e.t("settings","Enforce two-factor authentication"))+" ")]),e.enforced?[n("h3",[e._v(e._s(e.t("settings","Limit to groups")))]),e._v(" "+e._s(e.t("settings","Enforcement of two-factor authentication can be set for certain groups only."))+" "),n("p",{staticClass:"top-margin"},[e._v(" "+e._s(e.t("settings","Two-factor authentication is enforced for all members of the following groups."))+" ")]),n("p",[n("label",{attrs:{for:"enforcedGroups"}},[n("span",[e._v(e._s(e.t("settings","Enforced groups")))])]),n("NcSelect",{attrs:{"input-id":"enforcedGroups",options:e.groups,disabled:e.loading,multiple:!0,loading:e.loadingGroups,"close-on-select":!1},on:{search:e.searchGroup},model:{value:e.enforcedGroups,callback:function(o){e.enforcedGroups=o},expression:"enforcedGroups"}})],1),n("p",{staticClass:"top-margin"},[e._v(" "+e._s(e.t("settings","Two-factor authentication is not enforced for members of the following groups."))+" ")]),n("p",[n("label",{attrs:{for:"excludedGroups"}},[n("span",[e._v(e._s(e.t("settings","Excluded groups")))])]),n("NcSelect",{attrs:{"input-id":"excludedGroups",options:e.groups,disabled:e.loading,multiple:!0,loading:e.loadingGroups,"close-on-select":!1},on:{search:e.searchGroup},model:{value:e.excludedGroups,callback:function(o){e.excludedGroups=o},expression:"excludedGroups"}})],1),n("p",{staticClass:"top-margin"},[n("em",[e._v(" "+e._s(e.t("settings","When groups are selected/excluded, they use the following logic to determine if a user has 2FA enforced: If no groups are selected, 2FA is enabled for everyone except members of the excluded groups. If groups are selected, 2FA is enabled for all members of these. If a user is both in a selected and excluded group, the selected takes precedence and 2FA is enforced."))+" ")])])]:e._e(),n("p",{staticClass:"top-margin"},[e.dirty?n("NcButton",{attrs:{type:"primary",disabled:e.loading},on:{click:e.saveChanges}},[e._v(" "+e._s(e.t("settings","Save changes"))+" ")]):e._e()],1)],2)},Le=[],qe=I(Pe,He,Le,!1,null,"88c02180",null,null);const Ue=qe.exports,je=j.getLoggerBuilder().setApp("settings").detectUser().build(),ze={name:"Encryption",components:{NcCheckboxRadioSwitch:R,NcSettingsSection:W,NcButton:A},data(){const e=g("settings","encryption-modules");return{encryptionReady:g("settings","encryption-ready"),encryptionEnabled:g("settings","encryption-enabled"),externalBackendsEnabled:g("settings","external-backends-enabled"),encryptionAdminDoc:g("settings","encryption-admin-doc"),encryptionModules:e,shouldDisplayWarning:!1,migrating:!1,defaultCheckedModule:Object.entries(e).find(n=>n[1].default)[0]}},computed:{migrationMessage(){return t("settings",'You need to migrate your encryption keys from the old encryption (ownCloud <= 8.0) to the new one. Please enable the "Default encryption module" and run {command}',{command:'"occ encryption:migrate"'})}},methods:{displayWarning(){this.encryptionEnabled?(this.encryptionEnabled=!1,this.shouldDisplayWarning=!1):this.shouldDisplayWarning=!this.shouldDisplayWarning},async update(e,n){var c,l;await te();const o=F("/apps/provisioning_api/api/v1/config/apps/{appId}/{key}",{appId:"core",key:e}),r=n?"yes":"no";try{const{data:i}=await x.post(o,{value:r});this.handleResponse({status:(l=(c=i.ocs)==null?void 0:c.meta)==null?void 0:l.status})}catch(i){this.handleResponse({errorMessage:t("settings","Unable to update server side encryption config"),error:i})}},async checkDefaultModule(){await this.update("default_encryption_module",this.defaultCheckedModule)},async enableEncryption(){this.encryptionEnabled=!0,await this.update("encryption_enabled",!0)},async handleResponse({status:e,errorMessage:n,error:o}){e!=="ok"&&(ne(n),je.error(n,{error:o}))}}};var Qe=function(){var e=this,n=e._self._c;return n("NcSettingsSection",{attrs:{name:e.t("settings","Server-side encryption"),description:e.t("settings","Server-side encryption makes it possible to encrypt files which are uploaded to this server. This comes with limitations like a performance penalty, so enable this only if needed."),"doc-url":e.encryptionAdminDoc}},[n("NcCheckboxRadioSwitch",{attrs:{checked:e.encryptionEnabled||e.shouldDisplayWarning,disabled:e.encryptionEnabled,type:"switch"},on:{"update:checked":e.displayWarning}},[e._v(" "+e._s(e.t("settings","Enable server-side encryption"))+" ")]),e.shouldDisplayWarning&&!e.encryptionEnabled?n("div",{staticClass:"notecard warning",attrs:{role:"alert"}},[n("p",[e._v(e._s(e.t("settings","Please read carefully before activating server-side encryption:")))]),n("ul",[n("li",[e._v(e._s(e.t("settings","Once encryption is enabled, all files uploaded to the server from that point forward will be encrypted at rest on the server. It will only be possible to disable encryption at a later date if the active encryption module supports that function, and all pre-conditions (e.g. setting a recover key) are met.")))]),n("li",[e._v(e._s(e.t("settings","Encryption alone does not guarantee security of the system. Please see documentation for more information about how the encryption app works, and the supported use cases.")))]),n("li",[e._v(e._s(e.t("settings","Be aware that encryption always increases the file size.")))]),n("li",[e._v(e._s(e.t("settings","It is always good to create regular backups of your data, in case of encryption make sure to backup the encryption keys along with your data.")))])]),n("p",{staticClass:"margin-bottom"},[e._v(" "+e._s(e.t("settings","This is the final warning: Do you really want to enable encryption?"))+" ")]),n("NcButton",{attrs:{type:"primary"},on:{click:function(o){return e.enableEncryption()}}},[e._v(" "+e._s(e.t("settings","Enable encryption"))+" ")])],1):e._e(),e.encryptionEnabled?n("div",[e.encryptionReady?n("div",[e.encryptionModules.length===0?n("p",[e._v(" "+e._s(e.t("settings","No encryption module loaded, please enable an encryption module in the app menu."))+" ")]):[n("h3",[e._v(e._s(e.t("settings","Select default encryption module:")))]),n("fieldset",e._l(e.encryptionModules,function(o,r){return n("NcCheckboxRadioSwitch",{key:r,attrs:{checked:e.defaultCheckedModule,value:r,type:"radio",name:"default_encryption_module"},on:{"update:checked":[function(c){e.defaultCheckedModule=c},e.checkDefaultModule]}},[e._v(" "+e._s(o.displayName)+" ")])}),1)]],2):e.externalBackendsEnabled?n("div",{domProps:{innerHTML:e._s(e.migrationMessage)}}):e._e()]):e._e()],1)},Ve=[],Ye=I(ze,Qe,Ve,!1,null,"985c6207",null,null);const Je=Ye.exports;m.use(oe);const Ke={enforced:!1,enforcedGroups:[],excludedGroups:[]},Xe={setEnforced(e,n){m.set(e,"enforced",n)},setEnforcedGroups(e,n){m.set(e,"enforcedGroups",n)},setExcludedGroups(e,n){m.set(e,"excludedGroups",n)}},$=new se({strict:!1,state:Ke,mutations:Xe});m.prototype.t=t,window.OC=window.OC||{},window.OC.Settings=window.OC.Settings||{},$.replaceState(g("settings","mandatory2FAState"));const Ze=m.extend(Ue);new Ze({store:$}).$mount("#two-factor-auth-settings");const et=m.extend(Je);new et().$mount("#vue-admin-encryption");
