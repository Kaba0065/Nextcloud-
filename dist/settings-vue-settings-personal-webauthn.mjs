/*! third party licenses: dist/vendor.LICENSE.txt */
import{bG as U,bR as S,bD as R,F as Y,b as L,X as j,a5 as q,aH as x,bO as F}from"./core-common.mjs";import{H as N}from"./chunks/style-3JoZM1Ml.mjs";import{r as M,a as J,c as z}from"./chunks/convert-UgP3-3C7.mjs";import{_ as X,r as Q,a as V}from"./chunks/_baseIteratee-BndskHKM.mjs";import{_ as Z}from"./chunks/_baseEach-BGqCZ98m.mjs";import{i as ee,c as te,e as ne,f as re}from"./chunks/_setToString-D2g9rVjk.mjs";import{i as ie}from"./chunks/isSymbol-D7eKlFoH.mjs";import{a as se,b as ae}from"./chunks/_isIterateeCall-cIIcpi4J.mjs";import{l as g}from"./chunks/logger-DsZcYtCa.mjs";import{n as C}from"./chunks/icons-BxSPavMS.mjs";import"./chunks/_Set-Cq4kerQ7.mjs";import"./chunks/toNumber-B8U-PqxL.mjs";import"./chunks/isPlainObject-wZJk5EJL.mjs";var m,E;function oe(){if(E)return m;E=1;var e=Z,n=ee;function r(i,u){var a=-1,s=n(i)?Array(i.length):[];return e(i,function(c,h,p){s[++a]=u(c,h,p)}),s}return m=r,m}var w,I;function ce(){if(I)return w;I=1;function e(n,r){var i=n.length;for(n.sort(r);i--;)n[i]=n[i].value;return n}return w=e,w}var y,B;function ue(){if(B)return y;B=1;var e=ie;function n(r,i){if(r!==i){var u=r!==void 0,a=r===null,s=r===r,c=e(r),h=i!==void 0,p=i===null,d=i===i,o=e(i);if(!p&&!o&&!c&&r>i||c&&h&&d&&!p&&!o||a&&h&&d||!u&&d||!s)return 1;if(!a&&!c&&!o&&r<i||o&&u&&s&&!a&&!c||p&&u&&s||!h&&s||!d)return-1}return 0}return y=n,y}var b,T;function de(){if(T)return b;T=1;var e=ue();function n(r,i,u){for(var a=-1,s=r.criteria,c=i.criteria,h=s.length,p=u.length;++a<h;){var d=e(s[a],c[a]);if(d){if(a>=p)return d;var o=u[a];return d*(o=="desc"?-1:1)}}return r.index-i.index}return b=n,b}var A,O;function le(){if(O)return A;O=1;var e=X,n=Q(),r=V,i=oe(),u=ce(),a=ne,s=de(),c=te,h=re;function p(d,o,G){o.length?o=e(o,function(l){return h(l)?function(f){return n(f,l.length===1?l[0]:l)}:l}):o=[c];var $=-1;o=e(o,a(r));var H=i(d,function(l,f,$e){var W=e(o,function(K){return K(l)});return{criteria:W,index:++$,value:l}});return u(H,function(l,f){return s(l,f,G)})}return A=p,A}var _,P;function he(){if(P)return _;P=1;var e=M(),n=le(),r=se,i=ae,u=r(function(a,s){if(a==null)return[];var c=s.length;return c>1&&i(a,s[0],s[1])?s=[]:c>2&&i(s[0],s[1],s[2])&&(s=[s[0]]),n(a,e(s,1),[])});return _=u,_}var pe=z,k=pe("sortBy",he());k.placeholder=J();var ve=k;const ge=U(ve);async function fe(){const e=S("/settings/api/personal/webauthn/registration");return(await R.get(e)).data}async function me(e,n){const r=S("/settings/api/personal/webauthn/registration");return(await R.post(r,{name:e,data:n})).data}async function we(e){const n=S("/settings/api/personal/webauthn/registration/".concat(e));await R.delete(n)}const D=e=>n=>(g.debug(e),n),v=Object.freeze({READY:1,REGISTRATION:2,NAMING:3,PERSIST:4}),ye={name:"AddDevice",components:{NcButton:Y},props:{httpWarning:Boolean,isHttps:{type:Boolean,default:!1},isLocalhost:{type:Boolean,default:!1}},data(){return{name:"",credential:{},RegistrationSteps:v,step:v.READY}},methods:{arrayToBase64String(e){return btoa(String.fromCharCode(...e))},start(){return this.step=v.REGISTRATION,console.debug("Starting WebAuthn registration"),N().then(this.getRegistrationData).then(this.register.bind(this)).then(()=>{this.step=v.NAMING}).catch(e=>{console.error(e.name,e.message),this.step=v.READY})},getRegistrationData(){console.debug("Fetching webauthn registration data");const e=function(n){n=n.replace(/-/g,"+").replace(/_/g,"/");const r=n.length%4;if(r){if(r===1)throw new Error("InvalidLengthError: Input base64url string is the wrong length to determine padding");n+=new Array(5-r).join("=")}return window.atob(n)};return fe().then(n=>(console.debug(n),n.challenge=Uint8Array.from(e(n.challenge),r=>r.charCodeAt(0)),n.user.id=Uint8Array.from(n.user.id,r=>r.charCodeAt(0)),n)).catch(n=>{throw console.error("Error getting webauthn registration data from server",n),new Error(t("settings","Server error while trying to add WebAuthn device"))})},register(e){return console.debug("starting webauthn registration"),navigator.credentials.create({publicKey:e}).then(n=>{this.credential={id:n.id,type:n.type,rawId:this.arrayToBase64String(new Uint8Array(n.rawId)),response:{clientDataJSON:this.arrayToBase64String(new Uint8Array(n.response.clientDataJSON)),attestationObject:this.arrayToBase64String(new Uint8Array(n.response.attestationObject))}}})},submit(){return this.step=v.PERSIST,N().then(D("confirmed password")).then(this.saveRegistrationData).then(D("registration data saved")).then(()=>this.reset()).then(D("app reset")).catch(console.error.bind(this))},async saveRegistrationData(){try{const e=await me(this.name,JSON.stringify(this.credential));g.info("new device added",{device:e}),this.$emit("added",e)}catch(e){throw g.error("Error persisting webauthn registration",{error:e}),new Error(t("settings","Server error while trying to complete WebAuthn device registration"))}},reset(){this.name="",this.registrationData={},this.step=v.READY}}};var be=function(){var e=this,n=e._self._c;return!e.isHttps&&!e.isLocalhost?n("div",[e._v(" "+e._s(e.t("settings","Passwordless authentication requires a secure connection."))+" ")]):n("div",[e.step===e.RegistrationSteps.READY?n("div",[n("NcButton",{attrs:{type:"primary"},on:{click:e.start}},[e._v(" "+e._s(e.t("settings","Add WebAuthn device"))+" ")])],1):e.step===e.RegistrationSteps.REGISTRATION?n("div",{staticClass:"new-webauthn-device"},[n("span",{staticClass:"icon-loading-small webauthn-loading"}),e._v(" "+e._s(e.t("settings","Please authorize your WebAuthn device."))+" ")]):e.step===e.RegistrationSteps.NAMING?n("div",{staticClass:"new-webauthn-device"},[n("span",{staticClass:"icon-loading-small webauthn-loading"}),n("input",{directives:[{name:"model",rawName:"v-model",value:e.name,expression:"name"}],attrs:{type:"text",placeholder:e.t("settings","Name your device")},domProps:{value:e.name},on:{":keyup":function(r){return!r.type.indexOf("key")&&e._k(r.keyCode,"enter",13,r.key,"Enter")?null:e.submit.apply(null,arguments)},input:function(r){r.target.composing||(e.name=r.target.value)}}}),n("NcButton",{attrs:{type:"primary"},on:{click:e.submit}},[e._v(" "+e._s(e.t("settings","Add"))+" ")])],1):e.step===e.RegistrationSteps.PERSIST?n("div",{staticClass:"new-webauthn-device"},[n("span",{staticClass:"icon-loading-small webauthn-loading"}),e._v(" "+e._s(e.t("settings","Adding your device â€¦"))+" ")]):n("div",[e._v(" Invalid registration step. This should not have happened. ")])])},Ae=[],_e=C(ye,be,Ae,!1,null,"49a94bd5",null,null);const De=_e.exports,Ne={name:"Device",components:{NcActionButton:L,NcActions:j},props:{name:{type:String,required:!0}}};var Se=function(){var e=this,n=e._self._c;return n("div",{staticClass:"webauthn-device"},[n("span",{staticClass:"icon-webauthn-device"}),e._v(" "+e._s(e.name||e.t("settings","Unnamed device"))+" "),n("NcActions",{attrs:{"force-menu":!0}},[n("NcActionButton",{attrs:{icon:"icon-delete"},on:{click:function(r){return e.$emit("delete")}}},[e._v(" "+e._s(e.t("settings","Delete"))+" ")])],1)],1)},Re=[],Ce=C(Ne,Se,Re,!1,null,"c824e14f",null,null);const Ee=Ce.exports,Ie=ge("name"),Be={components:{AddDevice:De,Device:Ee,NcNoteCard:q},props:{initialDevices:{type:Array,required:!0},isHttps:{type:Boolean,default:!1},isLocalhost:{type:Boolean,default:!1},hasPublicKeyCredential:{type:Boolean,default:!1}},data(){return{devices:this.initialDevices}},computed:{sortedDevices(){return Ie(this.devices)}},methods:{deviceAdded(e){g.debug("adding new device to the list ".concat(e.id)),this.devices.push(e)},async deleteDevice(e){g.info("deleting webauthn device ".concat(e)),await N(),await we(e),this.devices=this.devices.filter(n=>n.id!==e),g.info("webauthn device ".concat(e," removed successfully"))}}};var Te=function(){var e=this,n=e._self._c;return n("div",{staticClass:"section",attrs:{id:"security-webauthn"}},[n("h2",[e._v(e._s(e.t("settings","Passwordless Authentication")))]),n("p",{staticClass:"settings-hint hidden-when-empty"},[e._v(" "+e._s(e.t("settings","Set up your account for passwordless authentication following the FIDO2 standard."))+" ")]),e.devices.length===0?n("NcNoteCard",{attrs:{type:"info"}},[e._v(" "+e._s(e.t("settings","No devices configured."))+" ")]):n("h3",[e._v(" "+e._s(e.t("settings","The following devices are configured for your account:"))+" ")]),e._l(e.sortedDevices,function(r){return n("Device",{key:r.id,attrs:{name:r.name},on:{delete:function(i){return e.deleteDevice(r.id)}}})}),e.hasPublicKeyCredential?e._e():n("NcNoteCard",{attrs:{type:"warning"}},[e._v(" "+e._s(e.t("settings","Your browser does not support WebAuthn."))+" ")]),e.hasPublicKeyCredential?n("AddDevice",{attrs:{"is-https":e.isHttps,"is-localhost":e.isLocalhost},on:{added:e.deviceAdded}}):e._e()],2)},Oe=[],Pe=C(Be,Te,Oe,!1,null,"8966ea83",null,null);const xe=Pe.exports;x.prototype.t=t;const ke=x.extend(xe),Ge=F("settings","webauthn-devices");new ke({propsData:{initialDevices:Ge,isHttps:window.location.protocol==="https:",isLocalhost:window.location.hostname==="localhost",hasPublicKeyCredential:typeof window.PublicKeyCredential<"u"}}).$mount("#security-webauthn");
